<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZED按键助手 by 破亚空-Yakong-P</title>
    <style>
        body {
            /* font-family: ui-sans-serif; */
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .binding-list_advanced {
            width: 100%;
            max-width: 600px;
            margin-top: 20px;
        }

        .binding-item_advanced {
            background-color: #fff;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .binding-item_advanced span {
            display: block;
            margin-bottom: 5px;
        }

        .template-list_advanced {
            width: 100%;
            max-width: 600px;
            margin-top: 20px;
        }

        .template-item_advanced {
            background-color: #fff;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .template-item_advanced span {
            display: block;
            margin-bottom: 5px;
        }

        .input-group {
            margin: 10px 0;
        }

        input[type="text"] {
            padding: 5px;
            width: 100%;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .button-group {
            margin-top: 20px;
        }

        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        #dropArea {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            border: 3px dashed #4CAF50;
            font-size: 2em;
            background-color: rgba(76, 175, 80, 0.1);
            text-align: center;
            /*   padding: 20px; */
            border-radius: 0;
            white-space: pre-line;
            /* Ensures that newline characters are respected */
            z-index: 10;
            cursor: pointer;
            /* 鼠标指针提示 */
        }

        .hidden {
            display: none !important;
            /* 强制隐藏 */
        }

        .advanced {
            display: none !important;
            /* 强制隐藏 */
        }

        .advanced-edit-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        .advanced-field-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .advanced-label {
            margin-bottom: 5px;
            font-weight: bold;
        }

        .advanced-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .advanced-input.single-line {
            height: 40px;
        }

        .advanced-input.multi-line {
            min-height: 100px;
            resize: vertical;
        }

        #addBindingButton {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px;
            background-color: #ffcc00;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            width: 50px;
            height: 50px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 4px #ad8b00;
            /* 创建按钮下方的阴影 */
        }

        #addBindingButton:hover {
            background-color: #d4aa00;
        }

        #addBindingButton:active {
            box-shadow: 0 2px #ad8b00;
            /* 按下时阴影减小 */
            transform: translateY(4px);
            /* 按钮下移的效果 */
        }


        /* 模态框样式 */
        #bindingModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }

        .modal-content {
            background: #fff;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 400px;
            /* 确保内容宽度一致 */
            max-width: 90%;
            /* 防止窗口太窄时溢出 */
        }

        .modal-content h3 {
            margin: 0 0 20px 0;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input {
            width: 95%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .button-group button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .button-group button#saveBindingButton {
            background-color: #4CAF50;
            color: white;
        }

        .button-group button#saveBindingButton:hover {
            background-color: #45a049;
        }

        .button-group button#cancelBindingButton {
            background-color: #f44336;
            color: white;
        }

        .button-group button#cancelBindingButton:hover {
            background-color: #e53935;
        }

        /* 为输入框允许多行显示增加样式 */
        textarea {
            width: 95%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: none;
            /* 允许用户调整高度 */
            min-height: 10px;
            /* 最小高度 */
        }

        /* 设置容器宽度、布局和对齐 */
        #bindingList {
            display: flex;
            flex-direction: column;
            width: 80%;
            /* 改为100% */
            max-width: 600px;
            /* 保持最大宽度 */
            margin: 0 auto;
            /* 居中 */
            padding: 0;
            /* 添加一些水平内边距 */
            box-sizing: border-box;
            gap: 10px;
        }

        /* 设置容器宽度、布局和对齐 */
        #templateList {
            display: flex;
            flex-direction: column;
            width: 80%;
            /* 改为100% */
            max-width: 600px;
            /* 保持最大宽度 */
            margin: 10px auto;
            /* 居中 */
            padding: 0;
            /* 添加一些水平内边距 */
            box-sizing: border-box;
            gap: 10px;
        }

        /* 每个按键绑定的行 */
        .binding-item {
            display: block;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            background-color: #fff;
            cursor: grab;
        }

        /* 描述部分 */
        .binding-item .description {
            flex: 0;
            text-align: left;
            /* 向左对齐 */
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            padding-right: 10px;
            /* 与按钮之间留一些空间 */
        }

        /* 按钮样式 */
        .binding-item button {
            display: inline-flex;
            flex-shrink: 0;
            /* 防止按钮被挤压 */
            min-width: 45px;
            height: 40px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            /* 改为方形 */
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            margin-left: auto;
            /* 将按钮推到最右侧 */
            box-shadow: 0 4px #2e7d32;
            /* 创建按钮下方的阴影 */
        }

        /* 按钮悬浮效果 */
        .binding-item button:hover {
            background-color: #45a049;
        }

        /* 每个按键绑定的行 */
        .template-item {
            display: block;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            background-color: #fff;
        }

        /* 描述部分 */
        .template-item .description {
            flex: 0;
            text-align: left;
            /* 向左对齐 */
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            padding-right: 10px;
            /* 与按钮之间留一些空间 */
        }

        /* 按钮样式 */
        .template-item button {
            display: inline-flex;
            flex-shrink: 0;
            /* 防止按钮被挤压 */
            min-width: 45px;
            height: 40px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            /* 改为方形 */
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            margin-left: auto;
            /* 将按钮推到最右侧 */
            box-shadow: 0 4px #2e7d32;
            /* 创建按钮下方的阴影 */
        }

        /* 按钮悬浮效果 */
        .template-item button:hover {
            background-color: #45a049;
        }

        .keyDetectorOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            font-size: 2em;
            text-align: center;
        }

        #Info {
            position: fixed;
            top: 20px;
            right: 20px;
        }

        .togglerList {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            /* 设置为 flex 布局 */
            justify-content: flex-end;
            /* 水平方向右对齐 */
            align-items: flex-end;
            /* 垂直方向底部对齐 */
            flex-direction: column-reverse;
            /* 20241214:修复阻挡问题 */
            pointer-events: none;
        }

        .toggler {
            display: block;
            /* 使按钮堆叠 */
            align-items: end;
            /* 右对齐 */
            margin-bottom: 10px;
            /* 按钮之间的间距 */
            font-size: 24px;
            padding: 20px;
            /* width: 136px; */
            height: 71px;
            background-color: #4CAF50;
            color: white;
            /* 创建按钮下方的阴影 */
            box-shadow: 0 4px #2e7d32;
            /* 20241214:修复阻挡问题 */
            pointer-events: auto;
        }

        /* 20241214:固定[关于]的按钮宽度 */
        #Info {
            width: 136px;
        }

        .toggler:active {
            box-shadow: 0 2px #2e7d32;
            /* 按下时阴影减小 */
            transform: translateY(4px);
            /* 按钮下移的效果 */
        }

        /* 搜索框容器 */
        #searchContainer {
            max-width: 600px;
            width: 80%;
            margin: 20px auto;
            text-align: center;
        }

        /* 搜索框样式 */
        #searchBox {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }


        /* 消息框 */
        .popupContainerCSS {
            position: relative;
            top: 0px;
            left: 0px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-end;
            pointer-events: auto;
            /* 20241214:修复阻挡问题 */
            user-select: none;
            /* 20241214:防止文字选中 */
        }

        .popup {
            width: fit-content;
            background: white;
            margin-bottom: 10px;
            /* 每个元素底部之间的间隔 */
            padding: 25px 30px;
            /* 内边距 */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            border: 2px solid #007BFF;
            /* 明显的蓝色边框 */
            border-radius: 12px;
            top: 20px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            opacity: 1;
            transition: opacity 0.5s ease-out;
            z-index: 1000;
        }

        .popup.fade-out {
            opacity: 0;
        }

        .off {
            /* white blackground */
            background-color: #d6e4d6 !important;
            box-shadow: 0 2px #bdd3bd !important;
        }

        .on {
            background-color: #4CAF50;
        }

        .warm {
            background-color: #ffcc00 !important;
            box-shadow: 0 2px #ad8b00 !important;
        }

        .hot {
            background-color: #ff5722 !important;
        }

        /* 垃圾桶样式 */
        #trashBin {
            position: fixed;
            bottom: 20px;
            left: 20px;
            font-size: 80px;
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.2s, opacity 0.2s;
            opacity: 0.7;
            padding: 20px;
            /* 增加可点击区域 */
            background-color: rgba(128, 128, 128, 0.1);
            /* 添加背景 */
            border-radius: 10px;
        }

        #trashBin.drag-over {
            transform: scale(1.2);
            opacity: 1;
            background-color: rgba(255, 0, 0, 0.1);
            /* 高亮背景 */
        }

        #trashBin.hidden {
            display: none !important;
        }

        /* Style for the clip bin, similar to trash bin */
        #copyBin {
            position: fixed;
            top: 35%;
            /* Positioned above the trash bin */
            left: 20px;
            font-size: 80px;
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.2s, opacity 0.2s;
            opacity: 0.7;
            padding: 20px;
            background-color: rgba(128, 128, 128, 0.1);
            border-radius: 10px;
        }

        #copyBin.drag-over {
            transform: scale(1.2);
            opacity: 1;
            background-color: rgba(0, 255, 0, 0.1);
            /* Green highlight for copy */
        }

        #copyBin.hidden {
            display: none !important;
        }

        /* Style for the copy bin, similar to trash bin */
        #clipBin {
            position: fixed;
            top: 20px;
            /* Positioned above the trash bin */
            left: 20px;
            font-size: 80px;
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.2s, opacity 0.2s;
            opacity: 0.7;
            padding: 20px;
            background-color: rgba(128, 128, 128, 0.1);
            border-radius: 10px;
        }

        #clipBin.drag-over {
            transform: scale(1.2);
            opacity: 1;
            background-color: rgba(0, 255, 0, 0.1);
            /* Green highlight for copy */
        }

        #clipBin.hidden {
            display: none !important;
        }

        .draggable {
            /*             transition:
                transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s; */
            /*             cursor: move; */
        }

        .binding-item.drag-move-down {
            transform: translate(0px, 10px);
        }

        .binding-item.drag-move-up {
            transform: translate(0px, -10px);
        }

        .draggable:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .draggable.drag-over {
            /* transform: scale(0.98); */
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2);
            /*             border: 2px dashed #4CAF50; */
        }

        .drag-item {
            transform: scale(1.02);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2);
            border: 2px dashed #4CAF50;
        }
    </style>
</head>

<body>

    <h1 id="appTitle" class="hidden">CS2 按键绑定助手 for ZED (2024-12-14)</h1>

    <div id="dropArea">点击打开，或直接拖拽放置 📄 poyakong.cfg</div>
    <button id="addBindingButton" class="hidden advanced">+</button>
    <button id="Info" class="hidden toggler">关于</button>
    <div class="togglerList">
        <button id="autoSaveButton" class="hidden toggler">自动保存</button>
        <button id="advancedModeButton" class="hidden toggler">高级模式</button>
        <button id="exportSettingsButton" class="hidden toggler">设置导出</button>
        <button id="importSettingsButton" class="hidden toggler advanced">设置导入</button>
        <button id="clipboardButton" class="hidden toggler">复制到剪切板</button>
        <button id="autoClipboardButton" class="hidden toggler">自动复制到剪切板[√]</button>
        <div id="popupContainer" class="popupContainerCSS"></div>
    </div>
    <div id="searchContainer" class="hidden">
        <input type="text" id="searchBox" placeholder="全局搜索..." />
    </div>
    <div id="bindingList" class="binding-list hidden"></div>
    <div id="templateList" class="template-list hidden"></div>
    <div id="clipBin" class="hidden" title="拖放到这，复制到剪切板">📋</div>
    <div id="copyBin" class="hidden" title="拖放到这，可以多绑">📑</div>
    <div id="trashBin" class="hidden" title="拖放到这，进行删除">🗑️</div>


    <div id="bindingModal" class="hidden">
        <div class="modal-content">
            <h3>添加新绑定</h3>
            <div class="input-group">
                <label for="descriptionInput">Description:</label>
                <input type="text" id="descriptionInput" placeholder="例如：向前移动"></textarea>
            </div>
            <div class="input-group">
                <label for="bindInput">Bind (可选):</label>
                <input type="text" id="bindInput" placeholder="例如：w"></textarea>
            </div>
            <div class="input-group">
                <label for="commandInput">Command:</label>
                <textarea id="commandInput" placeholder="例如：bind [key] +forward"></textarea>
            </div>
            <div class="input-group">
                <label for="tagInput">Tag (逗号分隔，可多行):</label>
                <input type="text" id="tagInput" placeholder="例如：移动, 基本设置"></textarea>
            </div>
            <div class="button-group">
                <button id="saveBindingButton">保存</button>
                <button id="cancelBindingButton">取消</button>
            </div>
        </div>
    </div>


    <script>
        let currentFile = null;
        const dropArea = document.getElementById('dropArea');
        const bindingListElement = document.getElementById('bindingList');
        const templateListElement = document.getElementById('templateList');
        const addBindingButton = document.getElementById('addBindingButton');    // 新增绑定按钮
        const advancedModeButton = document.getElementById('advancedModeButton');    // 进阶模式按钮
        let advancedMode = false;    // 进阶模式
        const autoSaveButton = document.getElementById('autoSaveButton');    // 自动保存按钮
        let autoSaveMode = false;    // 自动保存模式
        const exportSettingsButton = document.getElementById('exportSettingsButton');    // 导出设置按钮
        const importSettingsButton = document.getElementById('importSettingsButton');    // 导入设置按钮
        const clipboardButton = document.getElementById('clipboardButton');    // 复制到剪切板按钮
        const autoClipboardButton = document.getElementById('autoClipboardButton');    // 自动复制到剪切板按钮
        let autoClipboardMode = true;    // 自动复制到剪切板模式
        const Info = document.getElementById('Info');    // 关于按钮

        const searchContainer = document.getElementById('searchContainer');
        const searchBox = document.getElementById('searchBox');

        // 彩蛋
        let secretCounter = 0;

        let bindings = [];
        let templates = [];
        let bindingsFilter = () => bindings; // 初始筛选函数，返回完整数组
        let templatesFilter = () => templates; // 初始筛选函数，返回完整数组

        // 20250117 cookies support 🍪 {color:#784D37}
        let cookiesEnabled = false;

        // 20250118 localstorage support 🗄 {color:#784D37}
        let localStorageEnabled = true;

        // 20250120 exec autoexec.cfg
        let needAutoExec = true;

        // Get trash bin element
        const trashBin = document.getElementById('trashBin');
        // 为垃圾桶添加拖放事件
        trashBin.addEventListener('dragover', trashBinDragOver);
        trashBin.addEventListener('dragleave', trashBinDragLeave);
        trashBin.addEventListener('drop', trashBinDrop);

        // Get copy bin element
        const copyBin = document.getElementById('copyBin');
        // Add events for copy bin
        copyBin.addEventListener('dragover', copyCopyBinDragOver);
        copyBin.addEventListener('dragleave', copyCopyBinDragLeave);
        copyBin.addEventListener('drop', copyCopyBinDrop);


        // Get clip bin element
        const clipBin = document.getElementById('clipBin');
        // Add events for clip bin
        clipBin.addEventListener('dragover', clipBinDragOver);
        clipBin.addEventListener('dragleave', clipBinDragLeave);
        clipBin.addEventListener('drop', clipBinDrop);

        const bindingModal = document.getElementById('bindingModal');
        const saveBindingButton = document.getElementById('saveBindingButton');
        const cancelBindingButton = document.getElementById('cancelBindingButton');

        const appTitle = document.getElementById('appTitle');

        // 显示模态框
        function showBindingModal() {
            bindingModal.classList.remove('hidden');
        }

        // 隐藏模态框
        function hideBindingModal() {
            bindingModal.classList.add('hidden');
        }

        // 显示消息框
        function showPopup(message, containerId = "popupContainer") {
            // Find the container by ID
            const container = document.getElementById(containerId);

            // Create a new popup element
            const popup = document.createElement('div');
            popup.classList.add('popup');
            popup.style.whiteSpace = 'pre-line'; // 允许换行
            popup.innerHTML = message;

            // Append it to the specified container
            container.appendChild(popup);

            // Automatically fade out and remove the popup
            setTimeout(() => {
                popup.classList.add('fade-out');
                popup.addEventListener('transitionend', () => popup.remove());
            }, 5000); // Popup stays for 5 seconds
        }

        // 保存绑定逻辑
        saveBindingButton.addEventListener('click', () => {
            const descriptionInput = document.getElementById('descriptionInput').value.trim();
            const bindInput = document.getElementById('bindInput').value.trim();
            const commandInput = document.getElementById('commandInput').value.trim();
            const tagInput = document.getElementById('tagInput').value.trim();

            if (descriptionInput && commandInput) {
                templates.push({
                    description: descriptionInput,
                    bind: bindInput || "", // bind 为空时设为默认空字符串
                    command: commandInput,
                    tag: tagInput.split(/[,，]/).map(tag => tag.trim()).filter(tag => tag)
                });
                renderBindings();
                hideBindingModal();
            } else {
                alert('请填写所有必填项 (Description 和 Command)！');
            }
        });

        // 取消按钮逻辑
        cancelBindingButton.addEventListener('click', hideBindingModal);

        // 绑定 "+" 按钮的事件
        addBindingButton.addEventListener('click', showBindingModal);

        // 绑定搜索功能
        searchBox.addEventListener("input", () => {
            const query = searchBox.value.trim().toLowerCase();
            const queryWords = query.split(/\s+/);
            // 过滤函数：每个单词都要在description中出现
            bindingsFilter = () => bindings.filter(binding =>
                queryWords.every(word => binding.description.toLowerCase().includes(word)) // 所有单词都需要匹配
            );

            templatesFilter = () => templates.filter(template =>
                queryWords.every(word => template.description.toLowerCase().includes(word)) // 所有单词都需要匹配
            );
            renderBindings(); // 根据筛选结果重新渲染
            renderTemplates();
        });

        // 重写 renderBindings 以确保每次渲染后重新绑定拖放事件
        function renderBindings(passingBindings = bindings) {
            // 原有的渲染逻辑保持不变
            const originalRenderResult = originalRenderBindings();

            // 重新绑定拖放事件
            attachDragEvents();

            return originalRenderResult;
        }


        // 核心渲染
        function originalRenderBindings(passingBindings = bindingsFilter) {
            // 如果 passingBindings 是函数，则调用它获取结果
            const dataToRender = typeof passingBindings === 'function'
                ? passingBindings()
                : passingBindings;

            if (!advancedMode) {

                bindingListElement.innerHTML = ''; // Clear existing content
                bindingListElement.classList.add('drag-list');

                dataToRender.forEach((bindingTemp, bindingTempIndex) => {
                    const originalIndex = bindings.indexOf(bindingTemp); // 获取原始索引
                    const bindingItem = document.createElement('div');
                    bindingItem.setAttribute('data-original-index', originalIndex); // 存储原始索引
                    bindingItem.classList.add('binding-item', 'draggable');
                    bindingItem.setAttribute('draggable', true);
                    bindingItem.id = `binding-${bindingTempIndex}`;
                    bindingItem.setAttribute('title', bindingTemp.description); // 添加title = description

                    // Create a container for layout
                    const itemContent = document.createElement('div');
                    itemContent.style.display = 'flex';
                    itemContent.style.justifyContent = 'space-between';
                    itemContent.style.alignItems = 'center';
                    itemContent.style.pointerEvents = 'none'; // 20241201-防止动画丢失

                    // Description text (left-aligned)
                    const descriptionSpan = document.createElement('span');
                    descriptionSpan.textContent = bindingTemp.description;
                    descriptionSpan.style.flex = '1';
                    descriptionSpan.style.textOverflow = 'ellipsis';
                    descriptionSpan.style.whiteSpace = 'nowrap';
                    descriptionSpan.style.overflow = 'hidden';
                    descriptionSpan.style.paddingLeft = '5px';
                    descriptionSpan.style.userSelect = 'none'; // 20241214-使文本不可被选中

                    // 20241202-增加公告功能
                    if (bindingTemp.tag && bindingTemp.tag[0] === ('公告')) {
                        if (bindingTemp.tag[1] && bindingTemp.tag[2]) {
                            const hyperLink = document.createElement('a');
                            hyperLink.textContent = bindingTemp.tag[1];
                            hyperLink.href = bindingTemp.tag[2];
                            hyperLink.target = '_blank'; // 在新窗口内打开
                            hyperLink.style.pointerEvents = 'auto'; // 使得超链接可以被点击
                            descriptionSpan.appendChild(hyperLink);
                        }
                    }

                    // Key setup button (right-aligned)
                    const keyButton = document.createElement('button');
                    keyButton.textContent = bindingTemp.bind || '设置';
                    keyButton.style.pointerEvents = 'auto'; // 20241202-修复按钮点击问题

                    // Add click event to setup key
                    keyButton.addEventListener('click', () => {
                        setupKeyDetector().then((key) => {
                            if (key) {
                                // 功能上是一样的
                                // bindingTemp[bindingTempIndex].bind = key;
                                bindings[originalIndex].bind = key;
                                renderBindings();
                                showPopup(`已更改 [${key}]➡️` + bindings[originalIndex].description, 'popupContainer');
                                // 20241214-autoClipboard
                                if (autoClipboardMode) {
                                    navigator.clipboard.writeText(extractAsCmd(bindings[originalIndex]));
                                    showPopup("❤️<span style='color: green;'>指令已复制到剪切板，控制台粘贴运行即可</span>", 'popupContainer');
                                }
                            }
                        });
                    });

                    // Drag and drop event listeners
                    bindingItem.addEventListener('dragstart', dragStart);
                    bindingItem.addEventListener('dragover', dragOver);
                    bindingItem.addEventListener('drop', drop);
                    bindingItem.addEventListener('dragenter', dragEnter);
                    bindingItem.addEventListener('dragleave', dragLeave);

                    // Assemble the item
                    itemContent.appendChild(descriptionSpan);
                    itemContent.appendChild(keyButton);

                    bindingItem.appendChild(itemContent);
                    bindingListElement.appendChild(bindingItem);
                });

            } else {
                // Advanced mode with editable fields
                bindingListElement.innerHTML = '';
                dataToRender.forEach((bindingTemp, bindingTempIndex) => {
                    const originalIndex = bindings.indexOf(bindingTemp); // 获取原始索引
                    const bindingItem = document.createElement('div');
                    bindingItem.setAttribute('data-original-index', originalIndex); // 存储原始索引
                    bindingItem.classList.add('binding-item_advanced');

                    // Create container for editable fields
                    const editContainer = document.createElement('div');
                    editContainer.classList.add('advanced-edit-container');

                    // Description input (single line)
                    const descriptionInput = document.createElement('input');
                    descriptionInput.type = 'text';
                    descriptionInput.value = bindingTemp.description;
                    descriptionInput.placeholder = 'Description';
                    descriptionInput.classList.add('advanced-input', 'single-line');

                    // Bind input (single line)
                    const bindInput = document.createElement('input');
                    bindInput.type = 'text';
                    bindInput.value = bindingTemp.bind;
                    bindInput.placeholder = 'Bind Key';
                    bindInput.classList.add('advanced-input', 'single-line');

                    // Command input (multi-line)
                    const commandInput = document.createElement('textarea');
                    commandInput.value = bindingTemp.command;
                    commandInput.placeholder = 'Command';
                    commandInput.classList.add('advanced-input', 'multi-line');

                    // Tag input (single line)
                    const tagInput = document.createElement('input');
                    tagInput.type = 'text';
                    tagInput.value = bindingTemp.tag.join(', ');
                    tagInput.placeholder = 'Tag (comma-separated)';
                    tagInput.classList.add('advanced-input', 'single-line');

                    // Add change event listeners to update the bindings
                    const updateBinding = () => {
                        bindings[originalIndex].description = descriptionInput.value;
                        bindings[originalIndex].bind = bindInput.value;
                        bindings[originalIndex].command = commandInput.value;
                        bindings[originalIndex].tag = tagInput.value.split(/[,，]/).map(tag => tag.trim()).filter(tag => tag);
                    };

                    descriptionInput.addEventListener('change', updateBinding);
                    bindInput.addEventListener('change', updateBinding);
                    commandInput.addEventListener('change', updateBinding);
                    tagInput.addEventListener('change', updateBinding);

                    // Create label for each input
                    const createLabel = (text) => {
                        const label = document.createElement('label');
                        label.textContent = text;
                        label.classList.add('advanced-label');
                        return label;
                    };

                    // Assemble the item
                    const fields = [
                        { label: 'Description:', input: descriptionInput },
                        { label: 'Bind:', input: bindInput },
                        { label: 'Command:', input: commandInput },
                        { label: 'Tag:', input: tagInput }
                    ];

                    fields.forEach(field => {
                        const fieldWrapper = document.createElement('div');
                        fieldWrapper.classList.add('advanced-field-wrapper');

                        const label = createLabel(field.label);
                        fieldWrapper.appendChild(label);
                        fieldWrapper.appendChild(field.input);

                        editContainer.appendChild(fieldWrapper);
                    });

                    bindingItem.appendChild(editContainer);
                    bindingListElement.appendChild(bindingItem);
                });
            }
        }

        // 核心渲染
        function renderTemplates(passingTemplates = templatesFilter) {
            // 如果 passingTemplates 是函数，则调用它获取结果
            const dataToRender = typeof passingTemplates === 'function'
                ? passingTemplates()
                : passingTemplates;

            if (!advancedMode) {
                templateListElement.innerHTML = ''; // Clear existing content
                templateListElement.classList.add('drag-list');

                dataToRender.forEach((templateTemp, templateTempIndex) => {
                    const originalIndex = templates.indexOf(templateTemp); // 获取原始索引
                    const templateItem = document.createElement('div');
                    templateItem.setAttribute('data-original-index', originalIndex); // 存储原始索引
                    templateItem.classList.add('template-item');
                    templateItem.setAttribute('title', templateTemp.description);// 添加title = description
                    // templateItem.classList.add('draggable');
                    // templateItem.setAttribute('draggable', true);
                    templateItem.id = `template-${templateTempIndex}`;

                    // Create a container for layout
                    const itemContent = document.createElement('div');
                    itemContent.style.display = 'flex';
                    itemContent.style.justifyContent = 'space-between';
                    itemContent.style.alignItems = 'center';

                    // Description text (left-aligned)
                    const descriptionSpan = document.createElement('span');
                    descriptionSpan.textContent = templateTemp.description;
                    descriptionSpan.style.flex = '1';
                    descriptionSpan.style.textOverflow = 'ellipsis';
                    descriptionSpan.style.whiteSpace = 'nowrap';
                    descriptionSpan.style.overflow = 'hidden';
                    descriptionSpan.style.paddingLeft = '5px';
                    descriptionSpan.style.userSelect = 'none'; // 20241214-使文本不可被选中

                    // 20241202-增加公告功能
                    if (templateTemp.tag && templateTemp.tag[0] === ('公告')) {
                        if (templateTemp.tag[1] && templateTemp.tag[2]) {
                            const hyperLink = document.createElement('a');
                            hyperLink.textContent = templateTemp.tag[1];
                            hyperLink.href = templateTemp.tag[2];
                            hyperLink.target = '_blank'; // 在新窗口内打开
                            hyperLink.style.pointerEvents = 'auto'; // 使得超链接可以被点击
                            descriptionSpan.appendChild(hyperLink);
                        }
                    }

                    // Key setup button (right-aligned)
                    const keyButton = document.createElement('button');
                    keyButton.textContent = templateTemp.bind || '设置';

                    // Add click event to setup key
                    keyButton.addEventListener('click', () => {
                        setupKeyDetector().then((key) => {
                            if (key) {
                                const newBinding = {
                                    description: templateTemp.description,
                                    bind: key,
                                    command: templateTemp.command,
                                    tag: templateTemp.tag
                                };
                                bindings.push(newBinding);
                                renderBindings();
                                showPopup(`已绑定[${key}]➡️` + templateTemp.description + "，请在上方列表查看", 'popupContainer');
                                if (autoClipboardMode) {
                                    navigator.clipboard.writeText(extractAsCmd(newBinding));
                                    showPopup("❤️<span style='color: green;'>指令已复制到剪切板，控制台粘贴运行即可</span>", 'popupContainer');
                                }
                            }
                        });
                    });
                    // Drag and drop event listeners
                    // templateItem.addEventListener('dragstart', dragStart);
                    // templateItem.addEventListener('dragover', dragOver);
                    // templateItem.addEventListener('drop', drop);
                    // templateItem.addEventListener('dragenter', dragEnter);
                    // templateItem.addEventListener('dragleave', dragLeave);

                    // Assemble the item
                    itemContent.appendChild(descriptionSpan);
                    itemContent.appendChild(keyButton);

                    templateItem.appendChild(itemContent);
                    templateListElement.appendChild(templateItem);
                });
            } else {
                // Advanced mode with editable fields
                templateListElement.innerHTML = '';
                dataToRender.forEach((templateTemp, templateTempIndex) => {
                    const originalIndex = templates.indexOf(templateTemp); // 获取原始索引
                    const templateItem = document.createElement('div');
                    templateItem.setAttribute('data-original-index', originalIndex); // 存储原始索引
                    templateItem.classList.add('template-item_advanced');

                    // Create container for editable fields
                    const editContainer = document.createElement('div');
                    editContainer.classList.add('advanced-edit-container');

                    // Description input (single line)
                    const descriptionInput = document.createElement('input');
                    descriptionInput.type = 'text';
                    descriptionInput.value = templateTemp.description;
                    descriptionInput.placeholder = 'Description';
                    descriptionInput.classList.add('advanced-input', 'single-line');

                    // Bind input (single line)
                    const bindInput = document.createElement('input');
                    bindInput.type = 'text';
                    bindInput.value = templateTemp.bind;
                    bindInput.placeholder = 'Bind Key';
                    bindInput.classList.add('advanced-input', 'single-line');

                    // Command input (multi-line)
                    const commandInput = document.createElement('textarea');
                    commandInput.value = templateTemp.command;
                    commandInput.placeholder = 'Command';
                    commandInput.classList.add('advanced-input', 'multi-line');

                    // Tag input (single line)
                    const tagInput = document.createElement('input');
                    tagInput.type = 'text';
                    tagInput.value = templateTemp.tag.join(', ');
                    tagInput.placeholder = 'Tag (comma-separated)';
                    tagInput.classList.add('advanced-input', 'single-line');

                    // Debug
                    // if (!templateTemp) {
                    //     console.log("templateTemp is null as tempIndex:" + templateTempIndex + " originalIndex:" + originalIndex);
                    // }
                    // if (!Array.isArray(templateTemp.tag)) {
                    //     console.log("templateTemp.tag is not an array as tempIndex:" + templateTempIndex + " originalIndex:" + originalIndex);
                    // }

                    // Add change event listeners to update the templates
                    const updateTemplates = () => {
                        templates[originalIndex].description = descriptionInput.value;
                        templates[originalIndex].bind = bindInput.value;
                        templates[originalIndex].command = commandInput.value;
                        templates[originalIndex].tag = tagInput.value.split(/[,，]/).map(tag => tag.trim()).filter(tag => tag);
                    };

                    descriptionInput.addEventListener('change', updateTemplates);
                    bindInput.addEventListener('change', updateTemplates);
                    commandInput.addEventListener('change', updateTemplates);
                    tagInput.addEventListener('change', updateTemplates);

                    // Create label for each input
                    const createLabel = (text) => {
                        const label = document.createElement('label');
                        label.textContent = text;
                        label.classList.add('advanced-label');
                        return label;
                    };

                    // Assemble the item
                    const fields = [
                        { label: 'Description:', input: descriptionInput },
                        { label: 'Bind:', input: bindInput },
                        { label: 'Command:', input: commandInput },
                        { label: 'Tag:', input: tagInput }
                    ];

                    fields.forEach(field => {
                        const fieldWrapper = document.createElement('div');
                        fieldWrapper.classList.add('advanced-field-wrapper');

                        const label = createLabel(field.label);
                        fieldWrapper.appendChild(label);
                        fieldWrapper.appendChild(field.input);

                        editContainer.appendChild(fieldWrapper);
                    });

                    templateItem.appendChild(editContainer);
                    templateListElement.appendChild(templateItem);
                });
            }
        }

        // 修改拖放事件处理逻辑
        let draggedItem = null;

        function dragStart(e) {
            draggedItem = e.target.closest('.draggable');
            e.dataTransfer.setData('text/plain', draggedItem.id);
            e.dataTransfer.effectAllowed = 'move'; // 允许拖放效果

            // draggedItem.classList.add('drag-item');
        }

        function dragOver(e) {
            e.preventDefault();
            return false;
        }

        function dragEnter(e) {
            const target = e.target.closest('.draggable');
            if (target && target !== draggedItem) {

                target.classList.add('drag-over');

                /*                 // 获取拖动元素和目标元素的索引
                                const draggedIndex = Array.from(target.parentNode.children).indexOf(draggedItem);
                                const targetIndex = Array.from(target.parentNode.children).indexOf(target);
                
                                // 添加CSS类进行动画
                                target.classList.add('drag-over');
                
                                // 根据索引判断移动方向
                                if (draggedIndex < targetIndex) {
                                    // 向下移动动画
                                    target.classList.add('drag-move-up');
                                } else if (draggedIndex > targetIndex) {
                                    // 向上移动动画 
                                    target.classList.add('drag-move-down');
                                } */
            }
        }

        function dragLeave(e) {
            const target = e.target.closest('.draggable');
            if (target) {

                target.classList.remove('drag-over', 'drag-move-down', 'drag-move-up');

                /*                 // 20241201-添加位移效果
                                // 延迟移除动画类，保持过渡效果
                                setTimeout(() => {
                                    target.classList.remove('drag-over', 'drag-move-down', 'drag-move-up');
                                }, 300); // 与动画时间一致 */

            }
        }

        function trashBinDragOver(e) {
            e.preventDefault();
            trashBin.classList.add('drag-over');
        }

        function trashBinDragLeave(e) {
            trashBin.classList.remove('drag-over');
        }

        function trashBinDrop(e) {
            e.preventDefault();
            trashBin.classList.remove('drag-over');

            // 通过 id 获取被拖动的元素
            const draggedId = e.dataTransfer.getData('text/plain');
            const draggedElement = document.getElementById(draggedId);

            if (draggedElement) {
                // 获取被拖动元素的索引
                const originalIndex = parseInt(draggedElement.dataset.originalIndex, 10); // 获取原始索引

                // 显示删除提示
                showPopup("已移除" + bindings[originalIndex].description, 'popupContainer');

                // 从 bindings 数组中移除对应的绑定
                bindings.splice(originalIndex, 1);

                // 重新渲染绑定列表
                renderBindings();
            }

            // 清除拖放状态
            draggedItem = null;
        }

        // Modify the existing script to add copy functionality
        function copyCopyBinDragOver(e) {
            e.preventDefault();
            copyBin.classList.add('drag-over');
        }

        function copyCopyBinDragLeave(e) {
            copyBin.classList.remove('drag-over');
        }

        function copyCopyBinDrop(e) {
            e.preventDefault();
            copyBin.classList.remove('drag-over');

            // Get the dragged item's ID
            const draggedId = e.dataTransfer.getData('text/plain');
            const draggedElement = document.getElementById(draggedId);

            if (draggedElement) {
                const originalIndex = parseInt(draggedElement.dataset.originalIndex, 10); // 获取原始索引

                // Create a deep copy of the binding at the dragged index
                const copiedBinding = JSON.parse(JSON.stringify(bindings[originalIndex]));

                // Insert the copied binding at the dragged index
                bindings.splice(originalIndex, 0, copiedBinding);

                // Re-render the bindings list
                renderBindings();

                // Show a popup to confirm copying
                showPopup("已复制" + bindings[originalIndex].description, 'popupContainer');
            }

            // Clear drag state
            draggedItem = null;
        }

        function clipBinDragOver(e) {
            e.preventDefault();
            clipBin.classList.add('drag-over');
        }

        function clipBinDragLeave(e) {
            clipBin.classList.remove('drag-over');
        }

        function clipBinDrop(e) {
            e.preventDefault();
            clipBin.classList.remove('drag-over');

            // 通过 id 获取被拖动的元素
            const draggedId = e.dataTransfer.getData('text/plain');
            const draggedElement = document.getElementById(draggedId);

            if (draggedElement) {
                const originalIndex = parseInt(draggedElement.dataset.originalIndex, 10); // 获取原始索引

                // 复制到剪切板
                const copyText = extractAsCmd(bindings[originalIndex]);
                if (copyText === "") {
                    showPopup("此设置的键位为空，无法复制到剪切板", 'popupContainer');
                    return;
                }
                navigator.clipboard.writeText(copyText)
                    .then(() => {
                        showPopup("绑定" + bindings[originalIndex].description + "已复制到剪切板", 'popupContainer');
                        console.log("绑定[" + copyText + "]已复制到剪切板");
                    })
                    .catch(err => {
                        showPopup("复制到剪切板失败" + err, 'popupContainer');
                    });
            }

            // 清除拖放状态
            draggedItem = null;
        }

        function drop(e) {
            e.preventDefault();
            const target = e.target.closest('.draggable');

            // 移除所有拖放样式
            document.querySelectorAll('.draggable').forEach(item => {
                item.classList.remove('drag-over');
            });

            if (target && target !== draggedItem) {
                // 获取拖动和目标元素的索引
                const draggedIndex = parseInt(draggedItem.dataset.originalIndex, 10);
                const targetIndex = parseInt(target.dataset.originalIndex, 10);

                // 从原位置移除绑定
                const removedBinding = bindings.splice(draggedIndex, 1)[0];

                // 在新位置插入绑定
                bindings.splice(targetIndex, 0, removedBinding);

                // 重新渲染绑定列表
                renderBindings();
            }

            // 清除拖放状态
            draggedItem = null;
        }

        // 确保所有拖放事件被正确绑定
        function attachDragEvents() {
            const draggableItems = document.querySelectorAll('.draggable');
            draggableItems.forEach(item => {
                item.addEventListener('dragstart', dragStart);
                item.addEventListener('dragover', dragOver);
                item.addEventListener('drop', drop);
                item.addEventListener('dragenter', dragEnter);
                item.addEventListener('dragleave', dragLeave);
            });
        }

        dropArea.addEventListener('dragover', (event) => {
            event.preventDefault();
        });

        dropArea.addEventListener('drop', (event) => {
            event.preventDefault();
            const file = event.dataTransfer.files[0];
            if (file) {
                handleFile(file);
            }
        });

        dropArea.addEventListener('click', () => {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.cfg';

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    handleFile(file);
                }
            });

            fileInput.click();
        });

        function handleFile(file) {
            const reader = new FileReader();

            reader.onload = function (event) {
                const content = event.target.result;

                if (content.startsWith("//poyakong.cfg")) {
                    dropArea.textContent = '文件载入中...';
                    setTimeout(() => {
                        currentFile = file;
                        dropArea.style.display = 'none';
                        removeHiddens();
                        loadBindingsFromFile(content);
                        showPopup("欢迎使用CS2按键助手！" + new Date().toLocaleString(), 'popupContainer'); // 显示欢迎信息 + 当前的时间
                    }, 500);
                } else {
                    dropArea.textContent = '似乎是不受支持的格式 请确保载入poyakong.cfg格式的文件';
                }
            };

            reader.onerror = function () {
                dropArea.textContent = '无法读取文件 请确保载入正确的文本格式的poyakong.cfg文件';
            };

            reader.readAsText(file, 'UTF-8');
        }

        function importFile() {
            // 创建一个隐藏的文件输入元素
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.cfg'; // 设置支持的文件类型

            // 监听文件选择事件
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0]; // 获取用户选择的文件
                if (file) {
                    // 读取文件内容
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const content = e.target.result; // 获取文件内容
                        // 处理文件内容（例如，解析绑定数据）
                        // 根据文件内容进行处理（例如解析.cfg文件）
                        console.log('文件内容:', content);

                        // 示例：假设文件内容为特定格式，可以进行解析并处理
                        // 如果文件是标准的 ".cfg" 格式，可以解析内容并调用相应的函数
                        if (content.startsWith("//poyakong.cfg")) {
                            // 解析文件内容并加载绑定
                            loadBindingsFromFile(content);
                        } else {
                            showPopup("似乎是不受支持的格式 请确保载入poyakong.cfg格式的文件", 'popupContainer');
                            console.error("不支持的文件格式");
                        }
                    };

                    reader.onerror = function () {
                        console.error('文件读取失败');
                    };

                    reader.readAsText(file); // 以文本形式读取文件
                } else {
                    console.error('未选择文件');
                }
            });

            // 触发文件选择对话框
            fileInput.click();
        }

        // 保存按钮 - 事件监听
        addEventListener('click', (event) => {
            if (event.target === exportSettingsButton) {
                exportSettings();
            }
        });

        // 导入按钮 - 事件监听
        addEventListener('click', (event) => {
            if (event.target === importSettingsButton) {
                importFile();
            }
        });

        // 剪切板按钮 - 事件监听
        addEventListener('click', (event) => {
            if (event.target === clipboardButton) {
                const copyText = extractAsCmd(bindings[0]);
                // if copyText is empty, show a popup fail message
                if (copyText === "") {
                    showPopup("此设置的键位为空，无法复制到剪切板", 'popupContainer');
                    return;
                }
                navigator.clipboard.writeText(copyText)
                    .then(() => {
                        showPopup("绑定已复制首条指令" + bindings[0].description + "到剪切板", 'popupContainer');
                    })
                    .catch(err => {
                        showPopup("复制到剪切板失败" + err, 'popupContainer');
                    });
            }
        });

        // 关于按钮 - 事件监听
        addEventListener('click', (event) => {
            if (event.target === Info) {
                showPopup("作者: 破亚空-Yakong-P 构筑版本: 2024-12-14\n", 'popupContainer');
                secretCounter++;
                if (secretCounter >= 5) {
                    secretTrigger();
                }
            }
        });

        // 彩蛋触发
        function secretTrigger() {
            advancedModeButton.classList.remove('hidden');
            Info.classList.add('hidden');
            showPopup("你发现了一个秘密按钮，点击它可以开启进阶模式！", 'popupContainer');
            showPopup("你发现了一个秘密按钮，点击它可以开启进阶模式！", 'popupContainer');
            showPopup("你发现了一个秘密按钮，点击它可以开启进阶模式！", 'popupContainer');
            showPopup("你发现了一个秘密按钮，点击它可以开启进阶模式！", 'popupContainer');
            showPopup("你发现了一个秘密按钮，点击它可以开启进阶模式！", 'popupContainer');
            showPopup("你发现了一个秘密按钮，点击它可以开启进阶模式！", 'popupContainer');
        }

        // 进阶模式按钮 - 切换
        function toggleAdvancedMode() {
            advancedMode = !advancedMode;
            checkAdvancedMode();
            renderBindings();
            renderTemplates();
        }

        // 进阶模式按钮 - 事件监听
        addEventListener('click', (event) => {
            if (event.target === advancedModeButton) {
                toggleAdvancedMode();
            }
        });

        // 20241214-自动复制模式 - 事件监听
        addEventListener('click', (event) => {
            if (event.target === autoClipboardButton) {
                autoClipboardMode = !autoClipboardMode;    // 切换自动复制模式
                if (!autoClipboardMode) {
                    autoClipboardButton.classList.add('off');
                    showPopup("自动复制指令功能已关闭", 'popupContainer');
                } else {
                    autoClipboardButton.classList.remove('off');
                    showPopup("自动复制指令功能已开启", 'popupContainer');
                }
            }
        });

        // 初次启动时的页面切换
        function removeHiddens() {
            appTitle.classList.remove('hidden'); // 显示标题
            bindingListElement.classList.remove('hidden'); // 显示绑定列表
            templateListElement.classList.remove('hidden'); //   显示模板列表
            addBindingButton.classList.remove('hidden'); // 显示添加绑定按钮
            // advancedModeButton.classList.remove('hidden'); // 显示进阶模式按钮
            // autoSaveButton.classList.remove('hidden'); //     显示自动保存按钮
            exportSettingsButton.classList.remove('hidden'); // 显示导出设置按钮
            importSettingsButton.classList.remove('hidden'); // 显示导入设置按钮
            importSettingsButton.classList.remove('advanced'); // 20241202-开放导入设置按钮给用户
            autoClipboardButton.classList.remove('hidden'); // 20241214-启用自动复制指令功能
            // importSettingsButton.classList.add('warm'); //  显示导入设置按钮颜色
            searchContainer.classList.remove('hidden'); // 显示搜索框
            trashBin.classList.remove('hidden'); // 显示垃圾桶
            copyBin.classList.remove('hidden'); // 显示复制桶
            // clipboardButton.classList.remove('hidden'); // 显示复制按钮
            clipBin.classList.remove('hidden'); // 显示剪切桶
            Info.classList.remove('hidden'); // 显示关于按钮
            // checkAdvancedMode(); // 检查是否开启进阶模式
            if (advancedMode) {
                addBindingButton.classList.remove('advanced');
            } else {
                addBindingButton.classList.add('advanced');
            }
            // checkAutoSaveMode();
            if (!autoSaveMode) {
                autoSaveButton.classList.add('off');
            }
        }

        // 显示 - 按钮控制 - 进阶模式
        function checkAdvancedMode() {
            if (advancedMode) {
                addBindingButton.classList.remove('advanced');
                // importSettingsButton.classList.remove('advanced');
                advancedModeButton.classList.add('warm');
            } else {
                addBindingButton.classList.add('advanced');
                // importSettingsButton.classList.add('advanced');
                advancedModeButton.classList.remove('warm');
            }
        }

        // 显示 - 按钮控制 - 自动保存
        function toggleAutoSave() {
            autoSaveMode = !autoSaveMode;    // 切换自动保存模式
            if (!autoSaveMode) {
                autoSaveButton.classList.add('off');
                showPopup("自动导出已关闭", 'popupContainer');
            } else {
                autoSaveButton.classList.remove('off');
                showPopup("自动导出已开启", 'popupContainer');
                exportSettings();
            }
        }

        // 功能 - 按钮控制 - 自动保存
        addEventListener('click', (event) => {
            if (event.target === autoSaveButton) {
                toggleAutoSave();
            }
        });

        // 文件导入
        function loadBindingsFromFile(passContent) {
            // Debug 导入时清洗文本内容 (\n -> \r\n)
            // const content = passContent
            //     .replace(/\r\n/g, '\n') // 先处理 CRLF
            //     .replace(/\r/g, '\n') // 处理老式 Mac 风格的 CR
            //     .replace(/\n/g, '\r\n'); // 统一换成 Windows 风格的 CRLF

            // Debug 导入时清洗文本内容 (\r\n -> \n)
            const content = passContent
                .replace(/\r\n/g, '\n') // 先处理 CRLF
                .replace(/\r/g, '\n') // 处理老式 Mac 风格的 CR

            // Find a line call "//template builder"
            const templateBuilderIndex = content.indexOf('//template builder');
            if (templateBuilderIndex >= 0) {
                let lines = content.substring(templateBuilderIndex).split('\n'); // Skip "//template builder" at the start
                // 每四行解析一个绑定, all start with "//"
                if (lines[1] && lines[1].startsWith('//')) {
                    lines = lines.filter(line => line.startsWith('//')); // 过滤出以“//”开头的行

                    for (let i = 1; i < lines.length; i += 4) {
                        // 检查是否有足够的行
                        if (i + 3 >= lines.length) {
                            console.warn("忽略不完整的绑定信息:", lines.slice(i));
                            break;
                        }

                        // 提取四行对应的字段
                        const description = lines[i].slice(2).trim(); // 去掉前缀 "//"
                        const bind = lines[i + 1].slice(2).trim(); // 第二行作为 bind
                        const command = lines[i + 2].slice(2).trim(); // 第三行作为 command
                        const tag = lines[i + 3].slice(2).trim().split(/[,，]/).map(tag => tag.trim()).filter(tag => tag);; // 第四行作为 tag

                        // 创建绑定对象并添加到数组
                        templates.push({ description, bind, command, tag });
                    }
                    renderTemplates();  // 渲染模板数据
                }
            }

            // Find a line call "//json-bindings"
            let jsonIndex = content.indexOf('//json-bindings');
            if (jsonIndex >= 0) {
                const lines = content.substring(jsonIndex).split('\n'); //.map(line => line.trim()); //冗余保险 // skin "//json-bindings"
                // 跳过 "//"
                if (lines[1] && lines[1].startsWith('//')) {
                    const jsonStr = lines[1].substring(2).trim(); // Skip "//" at the start
                    // 如果内容不是空的
                    if (jsonStr) {
                        try {
                            // 解析 JSON 字符串
                            const json = JSON.parse(jsonStr);
                            // 将解析的 JSON append to the existing bindings
                            bindings.push(...json);
                            renderBindings();  // 渲染绑定数据
                        } catch (e) {
                            showPopup("不明原因导致json-bindings解析失败" + e, 'popupContainer');
                            console.error("JSON 解析失败:" + e, e);
                        }
                    }
                }
            }

            // Find a line call "//json-templates"
            jsonIndex = content.indexOf('//json-templates');
            if (jsonIndex >= 0) {
                const lines = content.substring(jsonIndex).split('\n'); //.map(line => line.trim()); //冗余保险 // skin "//json-templates"
                // 跳过 "//"
                if (lines[1] && lines[1].startsWith('//')) {
                    const jsonStr = lines[1].substring(2).trim(); // Skip "//" at the start
                    // 如果内容不是空的
                    if (jsonStr) {
                        try {
                            // 解析 JSON 字符串
                            const json = JSON.parse(jsonStr);
                            // 将解析的 JSON append to the existing templates
                            templates.push(...json);
                            renderTemplates();  // 渲染绑定数据
                        } catch (e) {
                            showPopup("不明原因导致json-templates解析失败" + e, 'popupContainer');
                            console.error("JSON 解析失败:" + e, e);
                        }
                    }
                }
            }
        }

        // 文件导出
        function exportSettings() {
            try {
                // Construct the content string as three parts:
                // 1. the first line "//poyakong.cfg"
                // 2. for each binding, extractAsEcho() + extractAsCmd() + '\n'
                // 3. the JSON string for the bindings array
                const content = `//poyakong.cfg\n` +
                    `//` + appTitle.textContent + '\n' +
                    `//作者: 破亚空-Yakong-P\n` +
                    `//文件构筑: ` + new Date().toLocaleString() + '\n' +
                    '\n' +
                    '\n' +
                    `//使用方法：\n` +
                    `//1、将本文件放置于CounterStrike: Global Offesive/game/csgo/cfg文件夹中\n` +
                    `//2、打开游戏\n` +
                    `//3、在CS2设置里，启用控制台\n` +
                    `//4、在控制台里，输入exec poyakong.cfg，然后回车确认\n` +
                    `//5、如果导入成功，则会显示一堆的绑定的信息\n` +
                    `//6、如果导入失败，则会产生一条执行失败的信息：[InputService] exec: couldn't exec '{*}cfg/xxx.cfg', unable to read file\n` +
                    '\n' +
                    '\n' +
                    // 导出绑定
                    bindings.map(binding => {
                        // 检查 binding.bind 是否为空，空则跳过
                        if (!binding.bind) {
                            return '';
                        }
                        return `//` + binding.description + '\n' + extractAsCmd(binding) + '\n';
                    }).join('') +
                    '\n' +
                    '\n' +
                    // 生成echo
                    bindings.map(binding => {
                        // 检查 binding.templates 是否为空，空则跳过
                        if (!binding.bind) {
                            return '';
                        }
                        return extractAsEcho(binding);
                    }).join('') +
                    '\n' +
                    '\n' +
                    `//json-bindings\n` +
                    `//` + extractAsJson(bindings); //+
                // '\n' +
                // '\n' +
                // `//json-templates\n` +
                // `//` + extractAsJson(templates);

                // Create a file and write the content to it with name poyakong.cfg
                const file = new File([content], 'poyakong.cfg', { type: 'text/plain' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(file);
                link.download = 'poyakong.cfg';

                // Trigger download
                link.click();

                // Show success popup
                showPopup("保存成功，请将.cfg文件放置到CounterStrike: Global Offesive/game/csgo/cfg文件夹中，并在游戏内控制台输入exec poyakong", 'popupContainer');
            } catch (error) {
                // Log the error (for debugging purposes)
                console.error("导出文件时发生错误:", error);

                // Show error popup
                showPopup("保存失败，产生了预料之外的错误 " + errer, 'popupContainer');
            }
        }

        // Cmd
        function extractAsCmd(binding) {
            // check if the bind is empty
            if (!binding.bind) {
                return "";
            }
            // extract the bind and command
            const bind = binding.bind;
            const command = binding.command;
            // replace the "[key]" in the command with the bind
            let cmd = command.replace(/\[key\]/g, bind);
            // check every \n if they missing ; as ;\n
            cmd = cmd
                .split('\n')
                .map(line => (line.endsWith(';') ? line : line + ';'))
                .join('\n');

            // return the cmd
            return cmd;
        }

        // echo
        function extractAsEcho(binding) {
            // check if the bind is empty
            if (!binding.bind) {
                return "";
            }
            // extract the description and keybind
            const description = binding.description;
            const bind = binding.bind;
            // return the echo
            return `echo \"\[${bind}\]绑定为${description}\"\n`;
        }

        // json
        function extractAsJson(bindings) {
            return JSON.stringify(bindings, null, 0);
        }


        // 自动调整 textarea 高度
        function autoResizeTextarea() {
            const textarea = document.querySelectorAll('textarea');
            textarea.forEach((el) => {
                el.addEventListener('input', () => {
                    el.style.height = 'auto';  // 重置高度
                    el.style.height = el.scrollHeight - 15 + 'px';  // 设置高度为内容的实际高度
                });
            });
        }

        // 初始化自动调整高度的功能
        autoResizeTextarea();

        function setupKeyDetector() {
            return new Promise((resolve) => {
                // Create a full-screen overlay for key detection
                const keyDetectorOverlay = document.createElement('div');
                keyDetectorOverlay.classList.add('keyDetectorOverlay');

                keyDetectorOverlay.textContent = '请输入按键\n或按ESC退出';

                const specialKeyMappings = {
                    // Numpad keys
                    'NumpadAdd': 'kp_plus',
                    'NumpadSubtract': 'kp_minus',
                    'NumpadMultiply': 'kp_multiply',
                    'NumpadDivide': 'kp_divide',
                    'NumpadEnter': 'kp_enter',
                    'NumpadDecimal': 'kp_del',

                    // Modifier keys
                    'ControlRight': 'rCtrl',
                    'ShiftRight': 'rShift',
                    'AltRight': 'rAlt',

                    // Additional special keys
                    'Tab': 'Tab',
                    'CapsLock': 'Capslock',
                    'Insert': 'Ins',
                    'Delete': 'Del',
                    'Home': 'Home',
                    'End': 'End',
                    'PageUp': 'Pgup',
                    'PageDown': 'Pgdn',
                    'ScrollLock': 'Scrolllock',
                    'Pause': 'Pause',
                    'Backspace': 'Backspace',
                    'Semicolon': 'Semicolon'

                    // 'MetaRight': 'rwin'
                };

                // Numpad digit mapping
                for (let i = 0; i <= 9; i++) {
                    specialKeyMappings[`Numpad${i}`] = `kp_${i}`;
                }

                // Add key event listener
                const keyHandler = (event) => {
                    // Prevent default to stop propagation
                    event.preventDefault();

                    // Check for ESC key to exit
                    if (event.key === 'Escape') {
                        document.body.removeChild(keyDetectorOverlay);
                        document.removeEventListener('keydown', keyHandler);
                        resolve(null); // 返回 null 表示取消
                        return;
                    }

                    // Check for modifier keys first
                    if (['Control', 'Shift', 'Alt', 'CapsLock', 'Tab'].includes(event.key)) {
                        let modifierKey = '';
                        if (event.ctrlKey) modifierKey = event.location === event.DOM_KEY_LOCATION_RIGHT ? 'rCtrl' : 'Ctrl';
                        if (event.shiftKey) modifierKey = event.location === event.DOM_KEY_LOCATION_RIGHT ? 'rShift' : 'Shift';
                        if (event.altKey) modifierKey = event.location === event.DOM_KEY_LOCATION_RIGHT ? 'rAlt' : 'Alt';

                        // Check for other special keys
                        const specialKeyMap = {
                            'CapsLock': 'Capslock',
                            'Tab': 'Tab'
                        };

                        modifierKey = modifierKey || specialKeyMap[event.key];

                        if (modifierKey) {
                            // Remove the overlay
                            cleanup();
                            resolve(modifierKey);
                            return;
                        }
                    }

                    // Check for mappable special keys
                    const specialKey = specialKeyMappings[event.code] || specialKeyMappings[event.key];

                    // Determine the key to use
                    const bindKey = specialKey ||
                        (event.key.length === 1
                            ? event.key.toUpperCase()
                            : (['F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'F11', 'F12'].includes(event.key) ? event.key : null));

                    if (bindKey) {

                        // Remove the overlay
                        cleanup();
                        //
                        resolve(bindKey);
                        return;
                    }
                };

                const mouseHandler = (event) => {
                    event.preventDefault();

                    let mouseKey;
                    switch (event.button) {
                        case 0: mouseKey = 'mouse1'; break;
                        case 1: mouseKey = 'mouse3'; break;
                        case 2: mouseKey = 'mouse2'; break;
                        case 3: mouseKey = 'mouse4'; break; // Side button 1
                        case 4: mouseKey = 'mouse5'; break; // Side button 2
                    }

                    if (mouseKey) {
                        cleanup();
                        resolve(mouseKey);
                        return;
                    }
                };

                const wheelHandler = (event) => {
                    event.preventDefault();

                    const direction = event.deltaY < 0 ? 'mwheelup' : 'mwheeldown';
                    cleanup();
                    resolve(direction);
                };

                const cleanup = () => {
                    document.body.removeChild(keyDetectorOverlay);
                    document.removeEventListener('keydown', keyHandler);
                    document.removeEventListener('mousedown', mouseHandler);
                    document.removeEventListener('wheel', wheelHandler);
                };

                // Add event listener and append to body
                document.addEventListener('keydown', keyHandler);
                document.addEventListener('mousedown', mouseHandler);
                document.addEventListener('wheel', wheelHandler);
                document.body.appendChild(keyDetectorOverlay);
            });
        }

        // builders exporter
        function exportBuilders() {
            const content =
                `//poyakong.cfg\n` +
                `//template builder\n` +
                bindings.map(binding => {
                    return `//${binding.description}\n` +
                        `//${binding.bind}\n` +
                        `//${binding.command}\n` +
                        `//${binding.tag}\n`;
                }).join('');

            // Create a file and write the content to it with name poyakong.cfg
            const file = new File([content], 'poyakong.cfg', { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(file);
            link.download = 'poyakong.cfg';

            // Trigger download
            link.click();

            // Show success popup
            showPopup("Builder导出成功", 'popupContainer');
        }

        // window.onload for 生产环境
        window.onload = () => {
            const fileContent = "//poyakong.cfg\n//CS2 按键绑定助手 for ZED (2024-12-14)\n//作者: 破亚空-Yakong-P\n//文件构筑: 2024/12/14 11:00:56\n\n\n//使用方法：\n//1、将本文件放置于CounterStrike: Global Offesive/game/csgo/cfg文件夹中\n//2、打开游戏\n//3、在CS2设置里，启用控制台\n//4、在控制台里，输入exec poyakong.cfg，然后回车确认\n//5、如果导入成功，则会显示一堆的绑定的信息\n//6、如果导入失败，则会产生一条执行失败的信息：[InputService] exec: couldn't exec '{*}cfg/xxx.cfg', unable to read file\n\n\n\n\n\n\n//json-templates\n//[{\"description\":\"[公告]⬆️善用全局搜索⭐个人最爱⚠️注意事项\",\"bind\":\"\",\"command\":\"\",\"tag\":[]},{\"description\":\"[公告]⚠️使用教程：1、点击设置，然后按下键盘要绑定的按键 2、拖拽你要用的指令，至左上角，自动复制到剪切板 3、进入游戏，在控制台内[ctrl+v]，[enter]回车运行\",\"bind\":\"\",\"command\":\"\",\"tag\":[]},{\"description\":\"[公告]⚠️视频教程：\",\"bind\":\"\",\"command\":\"\",\"tag\":[\"公告\",\"BV1d1zkYSEgN\",\"https://www.bilibili.com/video/BV1d1zkYSEgN/\"]},{\"description\":\"[公告]⚠️如果是第一次使用，记得将配置文件autoexec.cfg放置到Counter-Strike Global Offensive\\\\game\\\\csgo\\\\cfg文件夹中！！！\",\"bind\":\"\",\"command\":\"\",\"tag\":[]},{\"description\":\"[按键设置]单键解除绑定，取消绑定\",\"bind\":\"\",\"command\":\"unbind [key];\",\"tag\":[]},{\"description\":\"[ZED][购买ZE道具]高爆手雷\",\"bind\":\"\",\"command\":\"bind [key] \\\"buy hegrenade\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买ZE道具]ZED回血针(电击枪)\",\"bind\":\"\",\"command\":\"bind [key] \\\"buy taser\\\";\",\"tag\":[]},{\"description\":\"[ZED][按键绑定]掏出 - 回血针\",\"bind\":\"\",\"command\":\"bind [key] \\\"slot12\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买ZE道具]冰冻雷(烟雾弹)\",\"bind\":\"\",\"command\":\"bind [key] \\\"buy smokegrenade\\\";\",\"tag\":[]},{\"description\":\"[ZED][按键绑定]掏出 - 冰冻雷\",\"bind\":\"\",\"command\":\"bind [key] \\\"slot8\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买ZE道具]燃烧瓶(燃烧弹)\",\"bind\":\"\",\"command\":\"bind [key] \\\"buy molotov\\\";\",\"tag\":[]},{\"description\":\"[ZED][按键绑定]掏出 - 燃烧瓶\",\"bind\":\"\",\"command\":\"bind [key] \\\"slot10\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买ZE道具]补充护甲$1000\",\"bind\":\"\",\"command\":\"bind [key] \\\"buy vesthelm\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][步枪]ak47\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_ak47\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][步枪]m4a1\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_m4a1\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][步枪]m4a4\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_m4a4\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][步枪]SG556\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_sg556\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][步枪]AUG\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_aug\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][步枪]法玛斯Famas\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_famas\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][步枪]咖喱Galilar - 加利尔AR\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_galilar\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][机枪]内格夫Negev\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_negev\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][机枪]M249\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_m249\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][狙击步枪]SSG-08\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_ssg08\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][狙击步枪]AWP\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_awp\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][狙击步枪]SCAR-20\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_scar20\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][狙击步枪]G3SG1\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_g3sg1\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][手枪]Tec-9\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_tec9\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][手枪]Five-seven\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_Fiveseven\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][手枪]p250\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_p250\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][手枪]沙鹰Deagle\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_deagle\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][手枪]左轮Revolver\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_revolver\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][手枪]双枪Elite\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_elite\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][手枪]CZ-75\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_cz\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][手枪]usp\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_usp_silencer\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][手枪]Glock-18\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_glock188\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][手枪]hkp2000\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_p2000\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][霰弹枪]新星Nova\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_nova\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][霰弹枪]Mag-7\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_mag7\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][霰弹枪]短喷sawedoff\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_sawedoff\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][霰弹枪]连喷xm1014\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_xm1014\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][冲锋枪]野牛Bizon\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_bizon\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][冲锋枪]MP9\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_mp9\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][冲锋枪]P90\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_p90\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][冲锋枪]MP7\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_mp7\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][冲锋枪]MP5-SD\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_mp5\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][冲锋枪]UMP-45\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_ump45\\\";\",\"tag\":[]},{\"description\":\"[ZED][购买武器][冲锋枪]Mac-10\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_mac10\\\";\",\"tag\":[]},{\"description\":\"[ZED][娱乐向]（❔）对人按下时，产生一个会跟踪的红色标记\",\"bind\":\"\",\"command\":\"bind [key] \\\"cl_ent_viewoffset\\\";\",\"tag\":[]},{\"description\":\"[ZED][画面显示]开/关 血迹显示!toggledecals\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_toggledecals\\\";\",\"tag\":[]},{\"description\":\"[ZED][快捷功能]查看自己有没有特殊封禁!status\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_status\\\";\",\"tag\":[]},{\"description\":\"[ZED][快捷功能]作为僵尸传送回出生点!ztele\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_ztele\\\";\",\"tag\":[]},{\"description\":\"[ZED][画面显示]修复悬浮菜单位置飘走消失的问题!resethud   [菜单修复]\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_resethud\\\";\",\"tag\":[]},{\"description\":\"[ZED][地图]呼出指挥投票菜单!vl\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_vl\\\";\",\"tag\":[]},{\"description\":\"[ZED][投票]投票延长地图!ve\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_ve\\\";\",\"tag\":[]},{\"description\":\"[ZED][地图]查看地图剩余延长次数!extendsleft\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_extendsleft\\\";\",\"tag\":[]},{\"description\":\"[ZED][地图]查看地图剩余时间!timeleft\",\"bind\":\"\",\"command\":\"bind [key] \\\"timeleft\\\";\",\"tag\":[]},{\"description\":\"[ZED][地图]查看已预订地图!nomlist\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_nomlist\\\";\",\"tag\":[]},{\"description\":\"[ZED][地图]在控制台显示服务器的地图池!listmap\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_nomlist\\\";\",\"tag\":[]},{\"description\":\"[ZED][地图]在控制台显示所有CD仍在冷却的地图!mapcooldowns\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_mapcooldowns\\\";\",\"tag\":[]},{\"description\":\"[ZED][地图]我突然不想RTV了!unrtv\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_rtv\\\";\",\"tag\":[]},{\"description\":\"[ZED][地图]我要R!T!V! - 请求换图!rtv\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_rtv\\\";\",\"tag\":[]},{\"description\":\"[ZED][菜单]呼出主菜单!menu\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_menu\\\";\",\"tag\":[]},{\"description\":\"[ZED][菜单]呼出画面设置菜单!hud\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_hud\\\";\",\"tag\":[]},{\"description\":\"[ZED][菜单]呼出个人杂项设置菜单!settings\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_settings\\\";\",\"tag\":[]},{\"description\":\"[ZED][菜单]呼出跳舞菜单!dance\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_dance\\\";\",\"tag\":[]},{\"description\":\"[ZED][菜单]呼出僵尸类型选择菜单!zclass\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_zlass\\\";\",\"tag\":[]},{\"description\":\"[ZED][菜单]呼出皮肤商城菜单!skin\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_skin\\\";\",\"tag\":[]},{\"description\":\"[ZED][功能]传送回出生点!ztele\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_ztele\\\";\",\"tag\":[]},{\"description\":\"[ZED][画面显示]隐藏符卡弹幕特效!hideeffect   [切换]\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_hideeffect\\\";\",\"tag\":[]},{\"description\":\"[ZED][画面显示]⭐启用夜视仪，地图滤镜切换   [开/关]\",\"bind\":\"\",\"command\":\"bind [key] \\\"mapFilter_0\\\";\",\"tag\":[]},{\"description\":\"[ZED][画面显示]开/关 子弹曳光效果（全局所有人）[切换]\",\"bind\":\"\",\"command\":\"bind [key] \\\"incrementvar r_drawtracers 0 1 1\\\";\",\"tag\":[]},{\"description\":\"[ZED][画面显示]开/关 第一人称的子弹曳光效果（仅自身）[切换]\",\"bind\":\"\",\"command\":\"bind [key] \\\"incrementvar r_drawtracers_firstperson 0 1 1\\\";\",\"tag\":[]},{\"description\":\"[ZED][画面显示]开启/关闭 屏幕晃动!toggleshake   [切换][屏幕震动]\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_hideshake\\\";\",\"tag\":[]},{\"description\":\"[ZED][音效]开/关 枪声!stopsound   [切换]\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_stopsound\\\";\",\"tag\":[]},{\"description\":\"[ZED][音效]开/关 僵尸被打头的声音!togglehit   [切换]\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_togglehit\\\";\",\"tag\":[]},{\"description\":\"[ZED][音效]调整音量 - 游戏音乐(BGM)（增大8%）[+]\",\"bind\":\"\",\"command\":\"bind [key] \\\"incrementvar snd_musicvolume -0.1 1.1 0.08\\\";\",\"tag\":[]},{\"description\":\"[ZED][音效]调整音量 - 游戏音乐(BGM)（减小8%）[-]\",\"bind\":\"\",\"command\":\"bind [key] \\\"incrementvar snd_musicvolume -0.1 1.1 -0.08\\\";\",\"tag\":[]},{\"description\":\"[ZED][音效]调整音量 - 队友语音（增大8%）[+]\",\"bind\":\"\",\"command\":\"bind [key] \\\"incrementvar snd_voipvolume -0.1 2.1 0.08\\\";\",\"tag\":[]},{\"description\":\"[ZED][音效]调整音量 - 队友语音（减小8%）[-]\",\"bind\":\"\",\"command\":\"bind [key] \\\"incrementvar snd_voipvolume -0.1 2.1 -0.08\\\";\",\"tag\":[]},{\"description\":\"[ZED][音效]调整音量 - 游戏总语音（增大5%）[+]\",\"bind\":\"\",\"command\":\"bind [key] \\\"incrementvar volume -0.1 1.1 0.05\\\";\",\"tag\":[]},{\"description\":\"[ZED][音效]调整音量 - 游戏总语音（减小5%）[-]\",\"bind\":\"\",\"command\":\"bind [key] \\\"incrementvar volume -0.1 1.1 -0.05\\\";\",\"tag\":[]},{\"description\":\"[ZED][音效]开/关 声音穿透 - 游戏切出桌面后，依然播放游戏声音\",\"bind\":\"\",\"command\":\"bind [key] \\\"incrementvar snd_mute_losefocus 0 1 1\\\";\",\"tag\":[]},{\"description\":\"[ZED][菜单]⭐呼出隐藏模型，隐藏特效的整合菜单\",\"bind\":\"\",\"command\":\"bind [key] \\\"radio1\\\";\",\"tag\":[]},{\"description\":\"[ZED][画面显示]开/关 隐藏身边1unit的队友（作为人类时）[切换]\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_hide 0\\\";\",\"tag\":[]},{\"description\":\"[ZED][画面显示]开/关 隐藏身边50unit的队友（作为人类时）[切换]\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_hide 50\\\";\",\"tag\":[]},{\"description\":\"[ZED][画面显示]开/关 隐藏身边150unit的队友（作为人类时）[切换]\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_hide 150\\\";\",\"tag\":[]},{\"description\":\"[ZED][画面显示]开/关 隐藏身边250unit的队友（作为人类时）[切换]\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_hide 250\\\";\",\"tag\":[]},{\"description\":\"[ZED][画面显示]开/关 隐藏身边9999unit的队友（作为人类时）[切换]\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_hide -1\\\";\",\"tag\":[]},{\"description\":\"[ZED][画面显示]开/关 绝不隐藏处于白名单的队友 - 需要在zed聊天框输入!setting -> 隐藏相关设置 -> 不隐藏指定的玩家 ->添加白名单   [切换]\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_hidefriends\\\";\",\"tag\":[]},{\"description\":\"[ZED][画面显示]开/关 绝不隐藏steam好友的模型!hidesteamfriends   [切换]\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_hidesteamfriends\\\";\",\"tag\":[]},{\"description\":\"[ZED][第三人称切换]⭐启用第三人称，恢复第一人称（角度保持）[tp]\",\"bind\":\"\",\"command\":\"bind [key] tp_0;\",\"tag\":[]},{\"description\":\"[ZED][第三人称切换][怀旧版本]CSGO版本的!tp，第三人称，第三人称固定摄像机观赏模式!mirror(mayamode)，第一人称\",\"bind\":\"\",\"command\":\"bind [key] \\\"mayamode_0\\\";\",\"tag\":[]},{\"description\":\"[ZED]🔄重置第三人称的摄像机位置\",\"bind\":\"\",\"command\":\"bind [key] \\\"cam_command 1;c_thirdpersonshoulder 0;cam_idealyaw 0;cam_idealpitch 0;cam_idealdist 150\\\";c_thirdpersonshoulderheight 5;c_thirdpersonshoulderoffset 20;\",\"tag\":[]},{\"description\":\"[ZED]第三人称 - 准星微调[上]\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_minpitch -180;c_maxpitch 180;incrementvar cam_idealpitch -90 90 -0.1\\\";\",\"tag\":[]},{\"description\":\"[ZED]第三人称 - 准星微调[下]\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_minpitch -180;c_maxpitch 180;incrementvar cam_idealpitch -90 90 0.1\\\";\",\"tag\":[]},{\"description\":\"[ZED]第三人称 - 准星微调[左]\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_minyaw -180;c_maxyaw 180;incrementvar cam_idealyaw -180 180 0.1\\\";\",\"tag\":[]},{\"description\":\"[ZED]第三人称 - 准星微调[右]\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_minyaw -180;c_maxyaw 180;incrementvar cam_idealyaw -180 180 -0.1\\\";\",\"tag\":[]},{\"description\":\"[ZED]第三人称 - 视角位置[拉近]\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_mindistance -500;c_maxdistance 500;incrementvar cam_idealdist -510 510 -5\\\";\",\"tag\":[]},{\"description\":\"[ZED]第三人称 - 视角位置[拉远]\",\"bind\":\"\",\"command\":\"bind [key] \\\"c_mindistance -500;c_maxdistance 500;incrementvar cam_idealdist -510 510 5\\\";\",\"tag\":[]},{\"description\":\"[ZED][观赏专用]使用第三人称近距离观赏角色正脸，让角色看着你   （只适配了正常高度的角色）（需要多按几次调整，因为不同角色视角的方向有细微差别）\",\"bind\":\"\",\"command\":\"bind [key] \\\"cam_command 1;c_thirdpersonshoulder 1;c_minyaw -360;c_maxyaw 360;c_thirdpersonshoulderheight 0;c_thirdpersonshoulderoffset 2;cam_idealdist 30;incrementvar cam_idealyaw 170 179.9 0.5\\\";\",\"tag\":[]},{\"description\":\"[通用][购买道具]钳子Defuser\",\"bind\":\"\",\"command\":\"bind [key] \\\"buy defuser\\\";\",\"tag\":[]},{\"description\":\"[通用][购买道具]闪光弹Flashbang\",\"bind\":\"\",\"command\":\"bind [key] \\\"buy flashbang\\\";\",\"tag\":[]},{\"description\":\"[通用][购买道具]诱饵弹Decoy\",\"bind\":\"\",\"command\":\"bind [key] \\\"buy decoy\\\";\",\"tag\":[]},{\"description\":\"[通用][购买道具]无头护甲$650\",\"bind\":\"\",\"command\":\"bind [key] \\\"buy vest\\\";\",\"tag\":[]}]\n\n//json-templates\n//[]";

            setTimeout(() => {
                // currentFile = null; // 一辈子没用过的函数
                dropArea.style.display = 'none';
                removeHiddens();
                loadBindingsFromFile(fileContent);
                showPopup("欢迎使用CS2按键助手！" + new Date().toLocaleString(), 'popupContainer'); // 显示欢迎信息 + 当前的时间
            }, 500);

            // 20250117 localStorage support 💿 {color:#784D37}
            if (localStorageEnabled == true) {
                // retrieve localStorage
                bindings = JSON.parse(localStorage.getItem('poyakong_bindings')) || [];
                originalRenderBindings();
            }

            // 20250117 cookies 🍪 {color:#784D37}
            if (cookiesEnabled == true && document.cookie.length > 0) {
                bindings = JSON.parse.decodeURIComponent((getCookie('poyakong_bindings')));
                originalRenderBindings();
            }
        }

        addEventListener('beforeunload', function (event) {

            // 20250117 localStorage support 💿 {color:#784D37}
            if (localStorageEnabled == true) {
                // store localStorage
                localStorage.setItem('poyakong_bindings', JSON.stringify(bindings));
            }

            // 20250117 cookies support 🍪 {color:#784D37}
            if (cookiesEnabled == true) {
                // store cookies
                setCookie('poyakong_bindings', encodeURIComponent(JSON.stringify(bindings)), 365);
            }
        });

        // 20250117 cookies support - functions 🍪 {color:#784D37}
        function setCookie(key, value = "", daysToExpired = 30) {
            const date = new Date();
            date.setTime(date.getTime() + (daysToExpired * 24 * 60 * 60 * 1000));
            const expires = "expires=" + date.toUTCString();
            document.cookie = `${key}=${value}; ${expires}; path=/`;
        }

        function getCookie(key) {
            const name = key + "=";
            const decodedCookie = decodeURIComponent(document.cookie);
            const cArray = decodedCookie.split('; ');

            for (let i = 0; i < cArray.length; i++) {
                let c = cArray[i];
                while (c.charAt(0) === ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) === 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

        function deleteCookie(key) {
            document.cookie = `${key}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;
        }

    </script>
</body>

</html>