<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZEDæŒ‰é”®åŠ©æ‰‹ by ç ´äºšç©º-Yakong-P</title>
    <style>
        body {
            /* font-family: ui-sans-serif; */
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .binding-list_advanced {
            width: 100%;
            max-width: 600px;
            margin-top: 20px;
        }

        .binding-item_advanced {
            background-color: #fff;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .binding-item_advanced span {
            display: block;
            margin-bottom: 5px;
        }

        .template-list_advanced {
            width: 100%;
            max-width: 600px;
            margin-top: 20px;
        }

        .template-item_advanced {
            background-color: #fff;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .template-item_advanced span {
            display: block;
            margin-bottom: 5px;
        }

        .input-group {
            margin: 10px 0;
        }

        input[type="text"] {
            padding: 5px;
            width: 100%;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .button-group {
            margin-top: 20px;
        }

        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        #dropArea {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            border: 3px dashed #4CAF50;
            font-size: 2em;
            background-color: rgba(76, 175, 80, 0.1);
            text-align: center;
            /*   padding: 20px; */
            border-radius: 0;
            white-space: pre-line;
            /* Ensures that newline characters are respected */
            z-index: 10;
            cursor: pointer;
            /* é¼ æ ‡æŒ‡é’ˆæç¤º */
        }

        .hidden {
            display: none !important;
            /* å¼ºåˆ¶éšè— */
        }

        .advanced {
            display: none !important;
            /* å¼ºåˆ¶éšè— */
        }

        #addBindingButton {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px;
            background-color: #ffcc00;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            width: 50px;
            height: 50px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 4px #ad8b00;
            /* åˆ›å»ºæŒ‰é’®ä¸‹æ–¹çš„é˜´å½± */
        }

        #addBindingButton:hover {
            background-color: #d4aa00;
        }

        #addBindingButton:active {
            box-shadow: 0 2px #ad8b00;
            /* æŒ‰ä¸‹æ—¶é˜´å½±å‡å° */
            transform: translateY(4px);
            /* æŒ‰é’®ä¸‹ç§»çš„æ•ˆæœ */
        }


        /* æ¨¡æ€æ¡†æ ·å¼ */
        #bindingModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }

        .modal-content {
            background: #fff;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 400px;
            /* ç¡®ä¿å†…å®¹å®½åº¦ä¸€è‡´ */
            max-width: 90%;
            /* é˜²æ­¢çª—å£å¤ªçª„æ—¶æº¢å‡º */
        }

        .modal-content h3 {
            margin: 0 0 20px 0;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input {
            width: 95%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .button-group button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .button-group button#saveBindingButton {
            background-color: #4CAF50;
            color: white;
        }

        .button-group button#saveBindingButton:hover {
            background-color: #45a049;
        }

        .button-group button#cancelBindingButton {
            background-color: #f44336;
            color: white;
        }

        .button-group button#cancelBindingButton:hover {
            background-color: #e53935;
        }

        /* ä¸ºè¾“å…¥æ¡†å…è®¸å¤šè¡Œæ˜¾ç¤ºå¢åŠ æ ·å¼ */
        textarea {
            width: 95%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: none;
            /* å…è®¸ç”¨æˆ·è°ƒæ•´é«˜åº¦ */
            min-height: 10px;
            /* æœ€å°é«˜åº¦ */
        }

        /* è®¾ç½®å®¹å™¨å®½åº¦ã€å¸ƒå±€å’Œå¯¹é½ */
        #bindingList {
            display: flex;
            flex-direction: column;
            width: 80%;
            /* æ”¹ä¸º100% */
            max-width: 600px;
            /* ä¿æŒæœ€å¤§å®½åº¦ */
            margin: 0 auto;
            /* å±…ä¸­ */
            padding: 0;
            /* æ·»åŠ ä¸€äº›æ°´å¹³å†…è¾¹è· */
            box-sizing: border-box;
            gap: 10px;
        }

        /* è®¾ç½®å®¹å™¨å®½åº¦ã€å¸ƒå±€å’Œå¯¹é½ */
        #templateList {
            display: flex;
            flex-direction: column;
            top: 9px;
            width: 80%;
            /* æ”¹ä¸º100% */
            max-width: 600px;
            /* ä¿æŒæœ€å¤§å®½åº¦ */
            margin: 10px auto;
            /* å±…ä¸­ */
            padding: 0;
            /* æ·»åŠ ä¸€äº›æ°´å¹³å†…è¾¹è· */
            box-sizing: border-box;
            gap: 10px;
        }

        /* æ¯ä¸ªæŒ‰é”®ç»‘å®šçš„è¡Œ */
        .binding-item {
            display: block;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            background-color: #fff;
        }

        /* æè¿°éƒ¨åˆ† */
        .binding-item .description {
            flex: 0;
            text-align: left;
            /* å‘å·¦å¯¹é½ */
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            padding-right: 10px;
            /* ä¸æŒ‰é’®ä¹‹é—´ç•™ä¸€äº›ç©ºé—´ */
        }

        /* æŒ‰é’®æ ·å¼ */
        .binding-item button {
            display: inline-flex;
            flex-shrink: 0;
            /* é˜²æ­¢æŒ‰é’®è¢«æŒ¤å‹ */
            min-width: 45px;
            height: 40px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            /* æ”¹ä¸ºæ–¹å½¢ */
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            margin-left: auto;
            /* å°†æŒ‰é’®æ¨åˆ°æœ€å³ä¾§ */
            box-shadow: 0 4px #2e7d32;
            /* åˆ›å»ºæŒ‰é’®ä¸‹æ–¹çš„é˜´å½± */
        }

        /* æŒ‰é’®æ‚¬æµ®æ•ˆæœ */
        .binding-item button:hover {
            background-color: #45a049;
        }

        /* æ¯ä¸ªæŒ‰é”®ç»‘å®šçš„è¡Œ */
        .template-item {
            display: block;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            background-color: #fff;
        }

        /* æè¿°éƒ¨åˆ† */
        .template-item .description {
            flex: 0;
            text-align: left;
            /* å‘å·¦å¯¹é½ */
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            padding-right: 10px;
            /* ä¸æŒ‰é’®ä¹‹é—´ç•™ä¸€äº›ç©ºé—´ */
        }

        /* æŒ‰é’®æ ·å¼ */
        .template-item button {
            display: inline-flex;
            flex-shrink: 0;
            /* é˜²æ­¢æŒ‰é’®è¢«æŒ¤å‹ */
            min-width: 45px;
            height: 40px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            /* æ”¹ä¸ºæ–¹å½¢ */
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            margin-left: auto;
            /* å°†æŒ‰é’®æ¨åˆ°æœ€å³ä¾§ */
            box-shadow: 0 4px #2e7d32;
            /* åˆ›å»ºæŒ‰é’®ä¸‹æ–¹çš„é˜´å½± */
        }

        /* æŒ‰é’®æ‚¬æµ®æ•ˆæœ */
        .template-item button:hover {
            background-color: #45a049;
        }

        .keyDetectorOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            font-size: 2em;
            text-align: center;
        }

        #Info {
            position: fixed;
            top: 20px;
            right: 20px;
        }

        .togglerList {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            /* è®¾ç½®ä¸º flex å¸ƒå±€ */
            justify-content: flex-end;
            /* æ°´å¹³æ–¹å‘å³å¯¹é½ */
            align-items: flex-end;
            /* å‚ç›´æ–¹å‘åº•éƒ¨å¯¹é½ */
            flex-direction: column-reverse;
        }

        .toggler {
            display: block;
            /* ä½¿æŒ‰é’®å †å  */
            align-items: end;
            /* å³å¯¹é½ */
            margin-bottom: 10px;
            /* æŒ‰é’®ä¹‹é—´çš„é—´è· */
            font-size: 24px;
            padding: 20px;
            width: 136px;
            height: 71px;
            background-color: #4CAF50;
            color: white;
            box-shadow: 0 4px #2e7d32;
            /* åˆ›å»ºæŒ‰é’®ä¸‹æ–¹çš„é˜´å½± */
        }

        .toggler:active {
            box-shadow: 0 2px #2e7d32;
            /* æŒ‰ä¸‹æ—¶é˜´å½±å‡å° */
            transform: translateY(4px);
            /* æŒ‰é’®ä¸‹ç§»çš„æ•ˆæœ */
        }

        /* æœç´¢æ¡†å®¹å™¨ */
        #searchContainer {
            max-width: 600px;
            width: 80%;
            margin: 20px auto;
            text-align: center;
        }

        /* æœç´¢æ¡†æ ·å¼ */
        #searchBox {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }


        /* æ¶ˆæ¯æ¡† */
        .popupContainerCSS {
            position: relative;
            top: 0px;
            left: 0px;
            display: block;
            justify-content: center;
            align-items: right;
        }

        .popup {
            background: white;
            margin-bottom: 10px;
            /* æ¯ä¸ªå…ƒç´ åº•éƒ¨ä¹‹é—´çš„é—´éš” */
            padding: 25px 30px;
            /* å†…è¾¹è· */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            border: 2px solid #007BFF;
            /* æ˜æ˜¾çš„è“è‰²è¾¹æ¡† */
            border-radius: 12px;
            top: 20px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            opacity: 1;
            transition: opacity 0.5s ease-out;
            z-index: 1000;
        }

        .popup.fade-out {
            opacity: 0;
        }

        .off {
            /* white blackground */
            background-color: #d6e4d6 !important;
            box-shadow: 0 2px #bdd3bd !important;
        }

        .on {
            background-color: #4CAF50;
        }

        .warm {
            background-color: #ffcc00 !important;
            box-shadow: 0 2px #ad8b00 !important;
        }

        .hot {
            background-color: #ff5722 !important;
        }

        /* åƒåœ¾æ¡¶æ ·å¼ */
        #trashBin {
            position: fixed;
            bottom: 20px;
            left: 20px;
            font-size: 80px;
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.2s, opacity 0.2s;
            opacity: 0.7;
            padding: 20px;
            /* å¢åŠ å¯ç‚¹å‡»åŒºåŸŸ */
            background-color: rgba(128, 128, 128, 0.1);
            /* æ·»åŠ èƒŒæ™¯ */
            border-radius: 10px;
        }

        #trashBin.drag-over {
            transform: scale(1.2);
            opacity: 1;
            background-color: rgba(255, 0, 0, 0.1);
            /* é«˜äº®èƒŒæ™¯ */
        }

        #trashBin.hidden {
            display: none !important;
        }

        /* Style for the clip bin, similar to trash bin */
        #copyBin {
            position: fixed;
            top: 35%;
            /* Positioned above the trash bin */
            left: 20px;
            font-size: 80px;
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.2s, opacity 0.2s;
            opacity: 0.7;
            padding: 20px;
            background-color: rgba(128, 128, 128, 0.1);
            border-radius: 10px;
        }

        #copyBin.drag-over {
            transform: scale(1.2);
            opacity: 1;
            background-color: rgba(0, 255, 0, 0.1);
            /* Green highlight for copy */
        }

        #copyBin.hidden {
            display: none !important;
        }

        /* Style for the copy bin, similar to trash bin */
        #clipBin {
            position: fixed;
            top: 20px;
            /* Positioned above the trash bin */
            left: 20px;
            font-size: 80px;
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.2s, opacity 0.2s;
            opacity: 0.7;
            padding: 20px;
            background-color: rgba(128, 128, 128, 0.1);
            border-radius: 10px;
        }

        #clipBin.drag-over {
            transform: scale(1.2);
            opacity: 1;
            background-color: rgba(0, 255, 0, 0.1);
            /* Green highlight for copy */
        }

        #clipBin.hidden {
            display: none !important;
        }
    </style>
</head>

<body>

    <h1 id="appTitle" class="hidden">CS2 æŒ‰é”®ç»‘å®šåŠ©æ‰‹ for ZED (2024-11-28)</h1>

    <div id="dropArea">ç‚¹å‡»æ‰“å¼€ï¼Œæˆ–ç›´æ¥æ‹–æ‹½æ”¾ç½® ğŸ“„ poyakong.cfg</div>
    <button id="addBindingButton" class="hidden advanced">+</button>
    <button id="Info" class="hidden toggler">å…³äº</button>
    <div class="togglerList">
        <button id="autoSaveButton" class="hidden toggler">è‡ªåŠ¨ä¿å­˜</button>
        <button id="advancedModeButton" class="hidden toggler">é«˜çº§æ¨¡å¼</button>
        <button id="exportSettingsButton" class="hidden toggler">é…ç½®å¯¼å‡º</button>
        <button id="importSettingsButton" class="hidden toggler advanced">é…ç½®å¯¼å…¥</button>
        <button id="clipboardButton" class="hidden toggler">å¤åˆ¶åˆ°å‰ªåˆ‡æ¿</button>
        <div id="popupContainer" class="popupContainerCSS"></div>
    </div>
    <div id="searchContainer" class="hidden">
        <input type="text" id="searchBox" placeholder="å…¨å±€æœç´¢..." />
    </div>
    <div id="bindingList" class="binding-list hidden"></div>
    <div id="templateList" class="template-list hidden"></div>
    <div id="clipBin" class="hidden" title="æ‹–æ”¾åˆ°è¿™ï¼Œå¤åˆ¶åˆ°å‰ªåˆ‡æ¿">ğŸ“‹</div>
    <div id="copyBin" class="hidden" title="æ‹–æ”¾åˆ°è¿™ï¼Œå¯ä»¥å¤šç»‘">ğŸ“‘</div>
    <div id="trashBin" class="hidden" title="æ‹–æ”¾åˆ°è¿™ï¼Œè¿›è¡Œåˆ é™¤">ğŸ—‘ï¸</div>


    <div id="bindingModal" class="hidden">
        <div class="modal-content">
            <h3>æ·»åŠ æ–°ç»‘å®š</h3>
            <div class="input-group">
                <label for="descriptionInput">Description:</label>
                <input type="text" id="descriptionInput" placeholder="ä¾‹å¦‚ï¼šå‘å‰ç§»åŠ¨"></textarea>
            </div>
            <div class="input-group">
                <label for="bindInput">Bind (å¯é€‰):</label>
                <input type="text" id="bindInput" placeholder="ä¾‹å¦‚ï¼šw"></textarea>
            </div>
            <div class="input-group">
                <label for="commandInput">Command:</label>
                <textarea id="commandInput" placeholder="ä¾‹å¦‚ï¼šbind [key] +forward"></textarea>
            </div>
            <div class="input-group">
                <label for="tagInput">Tags (é€—å·åˆ†éš”ï¼Œå¯å¤šè¡Œ):</label>
                <input type="text" id="tagInput" placeholder="ä¾‹å¦‚ï¼šç§»åŠ¨, åŸºæœ¬è®¾ç½®"></textarea>
            </div>
            <div class="button-group">
                <button id="saveBindingButton">ä¿å­˜</button>
                <button id="cancelBindingButton">å–æ¶ˆ</button>
            </div>
        </div>
    </div>


    <script>
        let currentFile = null;
        const dropArea = document.getElementById('dropArea');
        const bindingListElement = document.getElementById('bindingList');
        const templateListElement = document.getElementById('templateList');
        const addBindingButton = document.getElementById('addBindingButton');    // æ–°å¢ç»‘å®šæŒ‰é’®
        const advancedModeButton = document.getElementById('advancedModeButton');    // è¿›é˜¶æ¨¡å¼æŒ‰é’®
        let advancedMode = false;    // è¿›é˜¶æ¨¡å¼
        const autoSaveButton = document.getElementById('autoSaveButton');    // è‡ªåŠ¨ä¿å­˜æŒ‰é’®
        let autoSaveMode = false;    // è‡ªåŠ¨ä¿å­˜æ¨¡å¼
        const exportSettingsButton = document.getElementById('exportSettingsButton');    // å¯¼å‡ºè®¾ç½®æŒ‰é’®
        const importSettingsButton = document.getElementById('importSettingsButton');    // å¯¼å…¥è®¾ç½®æŒ‰é’®
        const clipboardButton = document.getElementById('clipboardButton');    // å¤åˆ¶åˆ°å‰ªåˆ‡æ¿æŒ‰é’®
        const Info = document.getElementById('Info');    // å…³äºæŒ‰é’®

        const searchContainer = document.getElementById('searchContainer');
        const searchBox = document.getElementById('searchBox');

        // å½©è›‹
        let secretCounter = 0;

        let bindings = [];
        let templates = [];
        let bindingsFilter = () => bindings; // åˆå§‹ç­›é€‰å‡½æ•°ï¼Œè¿”å›å®Œæ•´æ•°ç»„
        let templatesFilter = () => templates; // åˆå§‹ç­›é€‰å‡½æ•°ï¼Œè¿”å›å®Œæ•´æ•°ç»„

        // Get trash bin element
        const trashBin = document.getElementById('trashBin');

        // Get copy bin element
        const copyBin = document.getElementById('copyBin');

        // Get clip bin element
        const clipBin = document.getElementById('clipBin');

        const bindingModal = document.getElementById('bindingModal');
        const saveBindingButton = document.getElementById('saveBindingButton');
        const cancelBindingButton = document.getElementById('cancelBindingButton');

        const appTitle = document.getElementById('appTitle');

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showBindingModal() {
            bindingModal.classList.remove('hidden');
        }

        // éšè—æ¨¡æ€æ¡†
        function hideBindingModal() {
            bindingModal.classList.add('hidden');
        }

        // æ˜¾ç¤ºæ¶ˆæ¯æ¡†
        function showPopup(message, containerId) {
            // Find the container by ID
            const container = document.getElementById(containerId);

            // Create a new popup element
            const popup = document.createElement('div');
            popup.classList.add('popup');
            popup.textContent = message;

            // Append it to the specified container
            container.appendChild(popup);

            // Automatically fade out and remove the popup
            setTimeout(() => {
                popup.classList.add('fade-out');
                popup.addEventListener('transitionend', () => popup.remove());
            }, 3000); // Popup stays for 3 seconds
        }

        // ä¿å­˜ç»‘å®šé€»è¾‘
        saveBindingButton.addEventListener('click', () => {
            const descriptionInput = document.getElementById('descriptionInput').value.trim();
            const bindInput = document.getElementById('bindInput').value.trim();
            const commandInput = document.getElementById('commandInput').value.trim();
            const tagInput = document.getElementById('tagInput').value.trim();

            if (descriptionInput && commandInput) {
                templates.push({
                    description: descriptionInput,
                    bind: bindInput || "", // bind ä¸ºç©ºæ—¶è®¾ä¸ºé»˜è®¤ç©ºå­—ç¬¦ä¸²
                    command: commandInput,
                    tag: tagInput.split(/[,ï¼Œ]/).map(tag => tag.trim())
                });
                renderBindings();
                hideBindingModal();
            } else {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹ (Description å’Œ Command)ï¼');
            }
        });

        // å–æ¶ˆæŒ‰é’®é€»è¾‘
        cancelBindingButton.addEventListener('click', hideBindingModal);

        // ç»‘å®š "+" æŒ‰é’®çš„äº‹ä»¶
        addBindingButton.addEventListener('click', showBindingModal);

        // ç»‘å®šæœç´¢åŠŸèƒ½
        searchBox.addEventListener("input", () => {
            const query = searchBox.value.trim().toLowerCase();
            const lowerCaseQuery = query.trim().toLowerCase();
            bindingsFilter = () => bindings.filter(binding =>
                binding.description.toLowerCase().includes(lowerCaseQuery)
            );
            templatesFilter = () => templates.filter(template =>
                template.description.toLowerCase().includes(lowerCaseQuery)
            );
            renderBindings(); // æ ¹æ®ç­›é€‰ç»“æœé‡æ–°æ¸²æŸ“
            RenderTemplates();
        });

        // é‡å†™ renderBindings ä»¥ç¡®ä¿æ¯æ¬¡æ¸²æŸ“åé‡æ–°ç»‘å®šæ‹–æ”¾äº‹ä»¶
        function renderBindings(filteredBindings = bindings) {
            // åŸæœ‰çš„æ¸²æŸ“é€»è¾‘ä¿æŒä¸å˜
            const originalRenderResult = originalRenderBindings(filteredBindings);

            // é‡æ–°ç»‘å®šæ‹–æ”¾äº‹ä»¶
            attachDragEvents();

            return originalRenderResult;
        }


        // æ ¸å¿ƒæ¸²æŸ“
        function originalRenderBindings(filteredBindings = bindingsFilter) {
            if (!advancedMode) {
                bindingListElement.innerHTML = ''; // Clear existing content
                bindingListElement.classList.add('drag-list');

                filteredBindings.forEach((filteredBinding, filteredIndex) => {
                    const originalIndex = bindings.indexOf(filteredBinding); // è·å–åŸå§‹ç´¢å¼•
                    const bindingItem = document.createElement('div');
                    bindingItem.setAttribute('data-original-index', originalIndex); // å­˜å‚¨åŸå§‹ç´¢å¼•
                    bindingItem.classList.add('binding-item', 'draggable');
                    bindingItem.setAttribute('draggable', true);
                    bindingItem.id = `binding-${filteredIndex}`;

                    // Create a container for layout
                    const itemContent = document.createElement('div');
                    itemContent.style.display = 'flex';
                    itemContent.style.justifyContent = 'space-between';
                    itemContent.style.alignItems = 'center';

                    // Description text (left-aligned)
                    const descriptionSpan = document.createElement('span');
                    descriptionSpan.textContent = filteredBinding.description;
                    descriptionSpan.style.flex = '1';
                    descriptionSpan.style.textOverflow = 'ellipsis';
                    descriptionSpan.style.whiteSpace = 'nowrap';
                    descriptionSpan.style.overflow = 'hidden';
                    descriptionSpan.style.paddingLeft = '5px';

                    // Key setup button (right-aligned)
                    const keyButton = document.createElement('button');
                    keyButton.textContent = filteredBinding.bind || 'è®¾ç½®';

                    // Add click event to setup key
                    keyButton.addEventListener('click', () => {
                        setupKeyDetector(filteredBinding, filteredIndex);
                    });

                    // Drag and drop event listeners
                    bindingItem.addEventListener('dragstart', dragStart);
                    bindingItem.addEventListener('dragover', dragOver);
                    bindingItem.addEventListener('drop', drop);
                    bindingItem.addEventListener('dragenter', dragEnter);
                    bindingItem.addEventListener('dragleave', dragLeave);

                    // Assemble the item
                    itemContent.appendChild(descriptionSpan);
                    itemContent.appendChild(keyButton);

                    bindingItem.appendChild(itemContent);
                    bindingListElement.appendChild(bindingItem);
                });

                // Add some CSS for drag and drop animations
                const style = document.createElement('style');
                style.textContent = `
            .draggable {
                transition: transform 0.2s, box-shadow 0.2s;
                cursor: move;
            }
            .draggable:hover {
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }
            .draggable.drag-over {
                transform: scale(1.02);
                box-shadow: 0 6px 8px rgba(0,0,0,0.2);
                border: 2px dashed #4CAF50;
            }
        `;
                document.head.appendChild(style);
            } else {
                // Advanced mode with editable fields
                bindingListElement.innerHTML = '';
                filteredBindings.forEach((filteredBinding, filteredIndex) => {
                    const originalIndex = bindings.indexOf(filteredBinding); // è·å–åŸå§‹ç´¢å¼•
                    const bindingItem = document.createElement('div');
                    bindingItem.setAttribute('data-original-index', originalIndex); // å­˜å‚¨åŸå§‹ç´¢å¼•
                    bindingItem.classList.add('binding-item_advanced');

                    // Create container for editable fields
                    const editContainer = document.createElement('div');
                    editContainer.classList.add('advanced-edit-container');

                    // Description input (single line)
                    const descriptionInput = document.createElement('input');
                    descriptionInput.type = 'text';
                    descriptionInput.value = filteredBinding.description;
                    descriptionInput.placeholder = 'Description';
                    descriptionInput.classList.add('advanced-input', 'single-line');

                    // Bind input (single line)
                    const bindInput = document.createElement('input');
                    bindInput.type = 'text';
                    bindInput.value = filteredBinding.bind;
                    bindInput.placeholder = 'Bind Key';
                    bindInput.classList.add('advanced-input', 'single-line');

                    // Command input (multi-line)
                    const commandInput = document.createElement('textarea');
                    commandInput.value = filteredBinding.command;
                    commandInput.placeholder = 'Command';
                    commandInput.classList.add('advanced-input', 'multi-line');

                    // Tags input (single line)
                    const tagInput = document.createElement('input');
                    tagInput.type = 'text';
                    tagInput.value = filteredBinding.tag.join(', ');
                    tagInput.placeholder = 'Tags (comma-separated)';
                    tagInput.classList.add('advanced-input', 'single-line');

                    // Add change event listeners to update the bindings
                    const updateBinding = () => {
                        bindings[filteredIndex].description = descriptionInput.value;
                        bindings[filteredIndex].bind = bindInput.value;
                        bindings[filteredIndex].command = commandInput.value;
                        bindings[filteredIndex].tag = tagInput.value.split(/[,ï¼Œ]/).map(tag => tag.trim()).filter(tag => tag);
                    };

                    descriptionInput.addEventListener('change', updateBinding);
                    bindInput.addEventListener('change', updateBinding);
                    commandInput.addEventListener('change', updateBinding);
                    tagInput.addEventListener('change', updateBinding);

                    // Create label for each input
                    const createLabel = (text) => {
                        const label = document.createElement('label');
                        label.textContent = text;
                        label.classList.add('advanced-label');
                        return label;
                    };

                    // Assemble the item
                    const fields = [
                        { label: 'Description:', input: descriptionInput },
                        { label: 'Bind:', input: bindInput },
                        { label: 'Command:', input: commandInput },
                        { label: 'Tags:', input: tagInput }
                    ];

                    fields.forEach(field => {
                        const fieldWrapper = document.createElement('div');
                        fieldWrapper.classList.add('advanced-field-wrapper');

                        const label = createLabel(field.label);
                        fieldWrapper.appendChild(label);
                        fieldWrapper.appendChild(field.input);

                        editContainer.appendChild(fieldWrapper);
                    });

                    bindingItem.appendChild(editContainer);
                    bindingListElement.appendChild(bindingItem);
                });

                // Add some CSS for styling
                const style = document.createElement('style');
                style.textContent = `
            .advanced-edit-container {
                display: flex;
                flex-direction: column;
                gap: 10px;
                width: 100%;
            }
            
            .advanced-field-wrapper {
                display: flex;
                flex-direction: column;
                width: 100%;
            }
            
            .advanced-label {
                margin-bottom: 5px;
                font-weight: bold;
            }
            
            .advanced-input {
                width: 100%;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
                box-sizing: border-box;
            }
            
            .advanced-input.single-line {
                height: 40px;
            }
            
            .advanced-input.multi-line {
                min-height: 100px;
                resize: vertical;
            }
        `;
                document.head.appendChild(style);
            }
        }

        // æ ¸å¿ƒæ¸²æŸ“
        function RenderTemplates(templatesFilter) {
            if (!advancedMode) {
                templateListElement.innerHTML = ''; // Clear existing content
                templateListElement.classList.add('drag-list');

                templates.forEach((filteredTemplates, filteredIndex) => {
                    const originalIndex = templates.indexOf(filteredTemplates); // è·å–åŸå§‹ç´¢å¼•
                    const templateItem = document.createElement('div');
                    templateItem.setAttribute('data-original-index', originalIndex); // å­˜å‚¨åŸå§‹ç´¢å¼•
                    templateItem.classList.add('template-item');
                    // templateItem.classList.add('draggable');
                    // templateItem.setAttribute('draggable', true);
                    templateItem.id = `template-${filteredIndex}`;

                    // Create a container for layout
                    const itemContent = document.createElement('div');
                    itemContent.style.display = 'flex';
                    itemContent.style.justifyContent = 'space-between';
                    itemContent.style.alignItems = 'center';

                    // Description text (left-aligned)
                    const descriptionSpan = document.createElement('span');
                    descriptionSpan.textContent = filteredTemplates.description;
                    descriptionSpan.style.flex = '1';
                    descriptionSpan.style.textOverflow = 'ellipsis';
                    descriptionSpan.style.whiteSpace = 'nowrap';
                    descriptionSpan.style.overflow = 'hidden';
                    descriptionSpan.style.paddingLeft = '5px';

                    // Key setup button (right-aligned)
                    const keyButton = document.createElement('button');
                    keyButton.textContent = filteredTemplates.bind || 'è®¾ç½®';

                    // Add click event to setup key
                    keyButton.addEventListener('click', () => {
                        setupKeyDetector(filteredTemplates, filteredIndex);
                    });

                    // Drag and drop event listeners
                    // templateItem.addEventListener('dragstart', dragStart);
                    // templateItem.addEventListener('dragover', dragOver);
                    // templateItem.addEventListener('drop', drop);
                    // templateItem.addEventListener('dragenter', dragEnter);
                    // templateItem.addEventListener('dragleave', dragLeave);

                    // Assemble the item
                    itemContent.appendChild(descriptionSpan);
                    itemContent.appendChild(keyButton);

                    templateItem.appendChild(itemContent);
                    templateListElement.appendChild(templateItem);
                });

                // Add some CSS for drag and drop animations
                const style = document.createElement('style');
                style.textContent = `
            .draggable {
                transition: transform 0.2s, box-shadow 0.2s;
                cursor: move;
            }
            .draggable:hover {
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }
            .draggable.drag-over {
                transform: scale(1.02);
                box-shadow: 0 6px 8px rgba(0,0,0,0.2);
                border: 2px dashed #4CAF50;
            }
        `;
                document.head.appendChild(style);
            } else {
                // Advanced mode with editable fields
                templateListElement.innerHTML = '';
                templates.forEach((filteredTemplates, filteredIndex) => {
                    const originalIndex = templates.indexOf(filteredTemplates); // è·å–åŸå§‹ç´¢å¼•
                    const templateItem = document.createElement('div');
                    templateItem.setAttribute('data-original-index', originalIndex); // å­˜å‚¨åŸå§‹ç´¢å¼•
                    templateItem.classList.add('template-item_advanced');

                    // Create container for editable fields
                    const editContainer = document.createElement('div');
                    editContainer.classList.add('advanced-edit-container');

                    // Description input (single line)
                    const descriptionInput = document.createElement('input');
                    descriptionInput.type = 'text';
                    descriptionInput.value = filteredTemplates.description;
                    descriptionInput.placeholder = 'Description';
                    descriptionInput.classList.add('advanced-input', 'single-line');

                    // Bind input (single line)
                    const bindInput = document.createElement('input');
                    bindInput.type = 'text';
                    bindInput.value = filteredTemplates.bind;
                    bindInput.placeholder = 'Bind Key';
                    bindInput.classList.add('advanced-input', 'single-line');

                    // Command input (multi-line)
                    const commandInput = document.createElement('textarea');
                    commandInput.value = filteredTemplates.command;
                    commandInput.placeholder = 'Command';
                    commandInput.classList.add('advanced-input', 'multi-line');

                    // Tags input (single line)
                    const tagInput = document.createElement('input');
                    tagInput.type = 'text';
                    tagInput.value = filteredTemplates.tag.join(', ');
                    tagInput.placeholder = 'Tags (comma-separated)';
                    tagInput.classList.add('advanced-input', 'single-line');

                    // Add change event listeners to update the templates
                    const updateTemplates = () => {
                        templates[filteredIndex].description = descriptionInput.value;
                        templates[filteredIndex].bind = bindInput.value;
                        templates[filteredIndex].command = commandInput.value;
                        templates[filteredIndex].tag = tagInput.value.split(/[,ï¼Œ]/).map(tag => tag.trim()).filter(tag => tag);
                    };

                    descriptionInput.addEventListener('change', updateTemplates);
                    bindInput.addEventListener('change', updateTemplates);
                    commandInput.addEventListener('change', updateTemplates);
                    tagInput.addEventListener('change', updateTemplates);

                    // Create label for each input
                    const createLabel = (text) => {
                        const label = document.createElement('label');
                        label.textContent = text;
                        label.classList.add('advanced-label');
                        return label;
                    };

                    // Assemble the item
                    const fields = [
                        { label: 'Description:', input: descriptionInput },
                        { label: 'Bind:', input: bindInput },
                        { label: 'Command:', input: commandInput },
                        { label: 'Tags:', input: tagInput }
                    ];

                    fields.forEach(field => {
                        const fieldWrapper = document.createElement('div');
                        fieldWrapper.classList.add('advanced-field-wrapper');

                        const label = createLabel(field.label);
                        fieldWrapper.appendChild(label);
                        fieldWrapper.appendChild(field.input);

                        editContainer.appendChild(fieldWrapper);
                    });

                    templateItem.appendChild(editContainer);
                    templateListElement.appendChild(templateItem);
                });

                // Add some CSS for styling
                const style = document.createElement('style');
                style.textContent = `
            .advanced-edit-container {
                display: flex;
                flex-direction: column;
                gap: 10px;
                width: 100%;
            }
            
            .advanced-field-wrapper {
                display: flex;
                flex-direction: column;
                width: 100%;
            }
            
            .advanced-label {
                margin-bottom: 5px;
                font-weight: bold;
            }
            
            .advanced-input {
                width: 100%;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
                box-sizing: border-box;
            }
            
            .advanced-input.single-line {
                height: 40px;
            }
            
            .advanced-input.multi-line {
                min-height: 100px;
                resize: vertical;
            }
        `;
                document.head.appendChild(style);
            }
        }

        // ä¿®æ”¹æ‹–æ”¾äº‹ä»¶å¤„ç†é€»è¾‘
        let draggedItem = null;

        function dragStart(e) {
            draggedItem = e.target.closest('.draggable');
            e.dataTransfer.setData('text/plain', draggedItem.id);

            // ä¸ºåƒåœ¾æ¡¶æ·»åŠ æ‹–æ”¾äº‹ä»¶
            trashBin.addEventListener('dragover', trashBinDragOver);
            trashBin.addEventListener('dragleave', trashBinDragLeave);
            trashBin.addEventListener('drop', trashBinDrop);

            // Add events for copy bin
            copyBin.addEventListener('dragover', copyCopyBinDragOver);
            copyBin.addEventListener('dragleave', copyCopyBinDragLeave);
            copyBin.addEventListener('drop', copyCopyBinDrop);

            // Add events for clip bin
            clipBin.addEventListener('dragover', clipBinDragOver);
            clipBin.addEventListener('dragleave', clipBinDragLeave);
            clipBin.addEventListener('drop', clipBinDrop);

            setTimeout(() => {
                draggedItem.classList.add('drag-over');
            }, 0);
        }

        function dragOver(e) {
            e.preventDefault();
            return false;
        }

        function dragEnter(e) {
            const target = e.target.closest('.draggable');
            if (target && target !== draggedItem) {
                target.classList.add('drag-over');
            }
        }

        function dragLeave(e) {
            const target = e.target.closest('.draggable');
            if (target) {
                target.classList.remove('drag-over');
            }
        }

        function trashBinDragOver(e) {
            e.preventDefault();
            trashBin.classList.add('drag-over');
        }

        function trashBinDragLeave(e) {
            trashBin.classList.remove('drag-over');
        }

        function trashBinDrop(e) {
            e.preventDefault();
            trashBin.classList.remove('drag-over');

            // é€šè¿‡ id è·å–è¢«æ‹–åŠ¨çš„å…ƒç´ 
            const draggedId = e.dataTransfer.getData('text/plain');
            const draggedElement = document.getElementById(draggedId);

            if (draggedElement) {
                // è·å–è¢«æ‹–åŠ¨å…ƒç´ çš„ç´¢å¼•
                const originalIndex = parseInt(draggedElement.dataset.originalIndex, 10); // è·å–åŸå§‹ç´¢å¼•

                // æ˜¾ç¤ºåˆ é™¤æç¤º
                showPopup("ç»‘å®š" + bindings[originalIndex].description + "å·²åˆ é™¤", 'popupContainer');

                // ä» bindings æ•°ç»„ä¸­ç§»é™¤å¯¹åº”çš„ç»‘å®š
                bindings.splice(originalIndex, 1);

                // é‡æ–°æ¸²æŸ“ç»‘å®šåˆ—è¡¨
                renderBindings();
            }

            // æ¸…é™¤æ‹–æ”¾çŠ¶æ€
            draggedItem = null;
        }

        // Modify the existing script to add copy functionality
        function copyCopyBinDragOver(e) {
            e.preventDefault();
            copyBin.classList.add('drag-over');
        }

        function copyCopyBinDragLeave(e) {
            copyBin.classList.remove('drag-over');
        }

        function copyCopyBinDrop(e) {
            e.preventDefault();
            copyBin.classList.remove('drag-over');

            // Get the dragged item's ID
            const draggedId = e.dataTransfer.getData('text/plain');
            const draggedElement = document.getElementById(draggedId);

            if (draggedElement) {
                const originalIndex = parseInt(draggedElement.dataset.originalIndex, 10); // è·å–åŸå§‹ç´¢å¼•

                // Create a deep copy of the binding at the dragged index
                const copiedBinding = JSON.parse(JSON.stringify(bindings[originalIndex]));

                // Insert the copied binding at the dragged index
                bindings.splice(originalIndex, 0, copiedBinding);

                // Re-render the bindings list
                renderBindings();

                // Show a popup to confirm copying
                showPopup("ç»‘å®š" + bindings[originalIndex].description + "å·²å¤åˆ¶", 'popupContainer');
            }

            // Clear drag state
            draggedItem = null;
        }

        function clipBinDragOver(e) {
            e.preventDefault();
            clipBin.classList.add('drag-over');
        }

        function clipBinDragLeave(e) {
            clipBin.classList.remove('drag-over');
        }

        function clipBinDrop(e) {
            e.preventDefault();
            clipBin.classList.remove('drag-over');

            // é€šè¿‡ id è·å–è¢«æ‹–åŠ¨çš„å…ƒç´ 
            const draggedId = e.dataTransfer.getData('text/plain');
            const draggedElement = document.getElementById(draggedId);

            if (draggedElement) {
                const originalIndex = parseInt(draggedElement.dataset.originalIndex, 10); // è·å–åŸå§‹ç´¢å¼•

                // å¤åˆ¶åˆ°å‰ªåˆ‡æ¿
                const copyText = extractAsCmd(bindings[originalIndex]);
                if (copyText === "") {
                    showPopup("æ­¤è®¾ç½®çš„é”®ä½ä¸ºç©ºï¼Œæ— æ³•å¤åˆ¶åˆ°å‰ªåˆ‡æ¿", 'popupContainer');
                    return;
                }
                navigator.clipboard.writeText(copyText)
                    .then(() => {
                        showPopup("ç»‘å®š" + bindings[originalIndex].description + "å·²å¤åˆ¶åˆ°å‰ªåˆ‡æ¿", 'popupContainer');
                        console.log("ç»‘å®š[" + copyText + "]å·²å¤åˆ¶åˆ°å‰ªåˆ‡æ¿");
                    })
                    .catch(err => {
                        showPopup("å¤åˆ¶åˆ°å‰ªåˆ‡æ¿å¤±è´¥" + err, 'popupContainer');
                    });
            }

            // æ¸…é™¤æ‹–æ”¾çŠ¶æ€
            draggedItem = null;
        }

        function drop(e) {
            e.preventDefault();
            const target = e.target.closest('.draggable');

            // ç§»é™¤æ‰€æœ‰æ‹–æ”¾æ ·å¼
            document.querySelectorAll('.draggable').forEach(item => {
                item.classList.remove('drag-over');
            });

            if (target && target !== draggedItem) {
                // è·å–æ‹–åŠ¨å’Œç›®æ ‡å…ƒç´ çš„ç´¢å¼•
                const draggedIndex = parseInt(draggedItem.dataset.originalIndex, 10);
                const targetIndex = parseInt(target.dataset.originalIndex, 10);

                // ä»åŸä½ç½®ç§»é™¤ç»‘å®š
                const removedBinding = bindings.splice(draggedIndex, 1)[0];

                // åœ¨æ–°ä½ç½®æ’å…¥ç»‘å®š
                bindings.splice(targetIndex, 0, removedBinding);

                // é‡æ–°æ¸²æŸ“ç»‘å®šåˆ—è¡¨
                renderBindings();
            }

            // æ¸…é™¤æ‹–æ”¾çŠ¶æ€
            draggedItem = null;
        }

        // ç¡®ä¿æ‰€æœ‰æ‹–æ”¾äº‹ä»¶è¢«æ­£ç¡®ç»‘å®š
        function attachDragEvents() {
            const draggableItems = document.querySelectorAll('.draggable');
            draggableItems.forEach(item => {
                item.addEventListener('dragstart', dragStart);
                item.addEventListener('dragover', dragOver);
                item.addEventListener('drop', drop);
                item.addEventListener('dragenter', dragEnter);
                item.addEventListener('dragleave', dragLeave);
            });
        }

        dropArea.addEventListener('dragover', (event) => {
            event.preventDefault();
        });

        dropArea.addEventListener('drop', (event) => {
            event.preventDefault();
            const file = event.dataTransfer.files[0];
            if (file) {
                handleFile(file);
            }
        });

        dropArea.addEventListener('click', () => {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.cfg';

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    handleFile(file);
                }
            });

            fileInput.click();
        });

        function handleFile(file) {
            const reader = new FileReader();

            reader.onload = function (event) {
                const content = event.target.result;

                if (content.startsWith("//poyakong.cfg")) {
                    dropArea.textContent = 'æ–‡ä»¶è½½å…¥ä¸­...';
                    setTimeout(() => {
                        currentFile = file;
                        dropArea.style.display = 'none';
                        removeHiddens();
                        loadBindingsFromFile(content);
                        showPopup("æ¬¢è¿ä½¿ç”¨CS2æŒ‰é”®åŠ©æ‰‹ï¼", 'popupContainer');
                    }, 500);
                } else {
                    dropArea.textContent = 'ä¼¼ä¹æ˜¯ä¸å—æ”¯æŒçš„æ ¼å¼\nè¯·ç¡®ä¿è½½å…¥poyakong.cfgæ ¼å¼çš„æ–‡ä»¶';
                }
            };

            reader.onerror = function () {
                dropArea.textContent = 'æ— æ³•è¯»å–æ–‡ä»¶\nè¯·ç¡®ä¿è½½å…¥æ­£ç¡®çš„æ–‡æœ¬æ ¼å¼çš„poyakong.cfgæ–‡ä»¶';
            };

            reader.readAsText(file, 'UTF-8');
        }

        function importFile() {
            // åˆ›å»ºä¸€ä¸ªéšè—çš„æ–‡ä»¶è¾“å…¥å…ƒç´ 
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.cfg'; // è®¾ç½®æ”¯æŒçš„æ–‡ä»¶ç±»å‹

            // ç›‘å¬æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0]; // è·å–ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶
                if (file) {
                    // è¯»å–æ–‡ä»¶å†…å®¹
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const content = e.target.result; // è·å–æ–‡ä»¶å†…å®¹
                        // å¤„ç†æ–‡ä»¶å†…å®¹ï¼ˆä¾‹å¦‚ï¼Œè§£æç»‘å®šæ•°æ®ï¼‰
                        importHandleFile(content);
                    };

                    reader.onerror = function () {
                        console.error('æ–‡ä»¶è¯»å–å¤±è´¥');
                    };

                    reader.readAsText(file); // ä»¥æ–‡æœ¬å½¢å¼è¯»å–æ–‡ä»¶
                } else {
                    console.error('æœªé€‰æ‹©æ–‡ä»¶');
                }
            });

            // è§¦å‘æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
            fileInput.click();
        }

        function importHandleFile(content) {
            // æ ¹æ®æ–‡ä»¶å†…å®¹è¿›è¡Œå¤„ç†ï¼ˆä¾‹å¦‚è§£æ.cfgæ–‡ä»¶ï¼‰
            console.log('æ–‡ä»¶å†…å®¹:', content);

            // ç¤ºä¾‹ï¼šå‡è®¾æ–‡ä»¶å†…å®¹ä¸ºç‰¹å®šæ ¼å¼ï¼Œå¯ä»¥è¿›è¡Œè§£æå¹¶å¤„ç†
            // å¦‚æœæ–‡ä»¶æ˜¯æ ‡å‡†çš„ ".cfg" æ ¼å¼ï¼Œå¯ä»¥è§£æå†…å®¹å¹¶è°ƒç”¨ç›¸åº”çš„å‡½æ•°
            if (content.startsWith("//poyakong.cfg")) {
                // è§£ææ–‡ä»¶å†…å®¹å¹¶åŠ è½½ç»‘å®š
                loadBindingsFromFile(content);
            } else {
                console.error("ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼");
            }
        }

        // ä¿å­˜æŒ‰é’® - äº‹ä»¶ç›‘å¬
        addEventListener('click', (event) => {
            if (event.target === exportSettingsButton) {
                exportSettings();
            }
        });

        // å¯¼å…¥æŒ‰é’® - äº‹ä»¶ç›‘å¬
        addEventListener('click', (event) => {
            if (event.target === importSettingsButton) {
                importFile();
            }
        });

        // å‰ªåˆ‡æ¿æŒ‰é’® - äº‹ä»¶ç›‘å¬
        addEventListener('click', (event) => {
            if (event.target === clipboardButton) {
                const copyText = extractAsCmd(bindings[0]);
                // if copyText is empty, show a popup fail message
                if (copyText === "") {
                    showPopup("æ­¤è®¾ç½®çš„é”®ä½ä¸ºç©ºï¼Œæ— æ³•å¤åˆ¶åˆ°å‰ªåˆ‡æ¿", 'popupContainer');
                    return;
                }
                navigator.clipboard.writeText(copyText)
                    .then(() => {
                        showPopup("ç»‘å®šå·²å¤åˆ¶é¦–æ¡æŒ‡ä»¤" + bindings[0].description + "åˆ°å‰ªåˆ‡æ¿", 'popupContainer');
                    })
                    .catch(err => {
                        showPopup("å¤åˆ¶åˆ°å‰ªåˆ‡æ¿å¤±è´¥" + err, 'popupContainer');
                    });
            }
        });

        // å…³äºæŒ‰é’® - äº‹ä»¶ç›‘å¬
        addEventListener('click', (event) => {
            if (event.target === Info) {
                showPopup("ä½œè€…: ç ´äºšç©º-Yakong-P\næ„ç­‘ç‰ˆæœ¬: 2024-11-28\n", 'popupContainer');
                secretCounter++;
                if (secretCounter >= 5) {
                    secretTrigger();
                }
            }
        });

        // å½©è›‹è§¦å‘
        function secretTrigger() {
            advancedModeButton.classList.remove('hidden');
            Info.classList.add('hidden');
            showPopup("ä½ å‘ç°äº†ä¸€ä¸ªç§˜å¯†æŒ‰é’®ï¼Œç‚¹å‡»å®ƒå¯ä»¥å¼€å¯è¿›é˜¶æ¨¡å¼ï¼", 'popupContainer');
            showPopup("ä½ å‘ç°äº†ä¸€ä¸ªç§˜å¯†æŒ‰é’®ï¼Œç‚¹å‡»å®ƒå¯ä»¥å¼€å¯è¿›é˜¶æ¨¡å¼ï¼", 'popupContainer');
            showPopup("ä½ å‘ç°äº†ä¸€ä¸ªç§˜å¯†æŒ‰é’®ï¼Œç‚¹å‡»å®ƒå¯ä»¥å¼€å¯è¿›é˜¶æ¨¡å¼ï¼", 'popupContainer');
            showPopup("ä½ å‘ç°äº†ä¸€ä¸ªç§˜å¯†æŒ‰é’®ï¼Œç‚¹å‡»å®ƒå¯ä»¥å¼€å¯è¿›é˜¶æ¨¡å¼ï¼", 'popupContainer');
            showPopup("ä½ å‘ç°äº†ä¸€ä¸ªç§˜å¯†æŒ‰é’®ï¼Œç‚¹å‡»å®ƒå¯ä»¥å¼€å¯è¿›é˜¶æ¨¡å¼ï¼", 'popupContainer');
            showPopup("ä½ å‘ç°äº†ä¸€ä¸ªç§˜å¯†æŒ‰é’®ï¼Œç‚¹å‡»å®ƒå¯ä»¥å¼€å¯è¿›é˜¶æ¨¡å¼ï¼", 'popupContainer');
        }

        // è¿›é˜¶æ¨¡å¼æŒ‰é’® - åˆ‡æ¢
        function toggleAdvancedMode() {
            advancedMode = !advancedMode;
            checkAdvancedMode();
            renderBindings();
            RenderTemplates();
        }

        // è¿›é˜¶æ¨¡å¼æŒ‰é’® - äº‹ä»¶ç›‘å¬
        addEventListener('click', (event) => {
            if (event.target === advancedModeButton) {
                toggleAdvancedMode();
            }
        });

        // åˆæ¬¡å¯åŠ¨æ—¶çš„é¡µé¢åˆ‡æ¢
        function removeHiddens() {
            appTitle.classList.remove('hidden'); // æ˜¾ç¤ºæ ‡é¢˜
            bindingListElement.classList.remove('hidden'); // æ˜¾ç¤ºç»‘å®šåˆ—è¡¨
            templateListElement.classList.remove('hidden'); //   æ˜¾ç¤ºæ¨¡æ¿åˆ—è¡¨
            addBindingButton.classList.remove('hidden'); // æ˜¾ç¤ºæ·»åŠ ç»‘å®šæŒ‰é’®
            // advancedModeButton.classList.remove('hidden'); // æ˜¾ç¤ºè¿›é˜¶æ¨¡å¼æŒ‰é’®
            // autoSaveButton.classList.remove('hidden'); //     æ˜¾ç¤ºè‡ªåŠ¨ä¿å­˜æŒ‰é’®
            exportSettingsButton.classList.remove('hidden'); // æ˜¾ç¤ºå¯¼å‡ºè®¾ç½®æŒ‰é’®
            importSettingsButton.classList.remove('hidden'); // æ˜¾ç¤ºå¯¼å…¥è®¾ç½®æŒ‰é’®
            // importSettingsButton.classList.add('warm'); //  æ˜¾ç¤ºå¯¼å…¥è®¾ç½®æŒ‰é’®é¢œè‰²
            searchContainer.classList.remove('hidden'); // æ˜¾ç¤ºæœç´¢æ¡†
            trashBin.classList.remove('hidden'); // æ˜¾ç¤ºåƒåœ¾æ¡¶
            copyBin.classList.remove('hidden'); // æ˜¾ç¤ºå¤åˆ¶æ¡¶
            // clipboardButton.classList.remove('hidden'); // æ˜¾ç¤ºå¤åˆ¶æŒ‰é’®
            clipBin.classList.remove('hidden'); // æ˜¾ç¤ºå‰ªåˆ‡æ¡¶
            Info.classList.remove('hidden'); // æ˜¾ç¤ºå…³äºæŒ‰é’®
            // checkAdvancedMode(); // æ£€æŸ¥æ˜¯å¦å¼€å¯è¿›é˜¶æ¨¡å¼
            if (advancedMode) {
                addBindingButton.classList.remove('advanced');
            } else {
                addBindingButton.classList.add('advanced');
            }
            // checkAutoSaveMode();
            if (!autoSaveMode) {
                autoSaveButton.classList.add('off');
            }
        }

        // æ˜¾ç¤º - æŒ‰é’®æ§åˆ¶ - è¿›é˜¶æ¨¡å¼
        function checkAdvancedMode() {
            if (advancedMode) {
                addBindingButton.classList.remove('advanced');
                importSettingsButton.classList.remove('advanced');
                advancedModeButton.classList.add('warm');
            } else {
                addBindingButton.classList.add('advanced');
                importSettingsButton.classList.add('advanced');
                advancedModeButton.classList.remove('warm');
            }
        }

        // æ˜¾ç¤º - æŒ‰é’®æ§åˆ¶ - è‡ªåŠ¨ä¿å­˜
        function toggleAutoSave() {
            autoSaveMode = !autoSaveMode;    // åˆ‡æ¢è‡ªåŠ¨ä¿å­˜æ¨¡å¼
            if (!autoSaveMode) {
                autoSaveButton.classList.add('off');
                showPopup("è‡ªåŠ¨å¯¼å‡ºå·²å…³é—­", 'popupContainer');
            } else {
                autoSaveButton.classList.remove('off');
                showPopup("è‡ªåŠ¨å¯¼å‡ºå·²å¼€å¯", 'popupContainer');
                exportSettings();
            }
        }

        // åŠŸèƒ½ - æŒ‰é’®æ§åˆ¶ - è‡ªåŠ¨ä¿å­˜
        addEventListener('click', (event) => {
            if (event.target === autoSaveButton) {
                toggleAutoSave();
            }
        });

        // æ–‡ä»¶å¯¼å…¥
        function loadBindingsFromFile(content) {
            // Find a line call "//template builder"
            const templateBuilderIndex = content.indexOf('//template builder');
            if (templateBuilderIndex >= 0) {
                const templateBuilderStr = content.substring(templateBuilderIndex + 19).trim(); // Skip "//template builder" at the start
                // æ¯å››è¡Œè§£æä¸€ä¸ªç»‘å®š, all start with "//"
                if (templateBuilderStr.startsWith('//')) {
                    const bindingStr = templateBuilderStr.substring(2).trim(); // Skip "//" at the start
                    const lines = templateBuilderStr.split('\n').filter(line => line.startsWith('//')); // è¿‡æ»¤å‡ºä»¥â€œ//â€å¼€å¤´çš„è¡Œ

                    for (let i = 0; i < lines.length; i += 4) {
                        // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„è¡Œ
                        if (i + 3 >= lines.length) {
                            console.warn("å¿½ç•¥ä¸å®Œæ•´çš„ç»‘å®šä¿¡æ¯:", lines.slice(i));
                            break;
                        }

                        // æå–å››è¡Œå¯¹åº”çš„å­—æ®µ
                        const description = lines[i].slice(2).trim(); // å»æ‰å‰ç¼€ "//"
                        const bind = lines[i + 1].slice(2).trim(); // ç¬¬äºŒè¡Œä½œä¸º bind
                        const command = lines[i + 2].slice(2).trim(); // ç¬¬ä¸‰è¡Œä½œä¸º command
                        const tags = lines[i + 3].slice(2).trim(); // ç¬¬å››è¡Œä½œä¸º tags

                        // åˆ›å»ºç»‘å®šå¯¹è±¡å¹¶æ·»åŠ åˆ°æ•°ç»„
                        bindings.push({ description, bind, command, tags });
                    }
                }
            }

            let jsonIndex = 0;
            let jsonStr = "";
            let firstLine = "";
            let json = {};

            // Find a line call "//json-bindings"
            jsonIndex = content.indexOf('//json-bindings');
            if (jsonIndex >= 0) {
                const jsonStr = content.substring(jsonIndex + 17).trim(); // skin "//json-bindings\n"
                // è·³è¿‡ "//"
                if (jsonStr.startsWith('//')) {
                    const firstLine = jsonStr.substring(2).split('\n')[0]; // Skip "//" at the start
                    // å¦‚æœå†…å®¹ä¸æ˜¯ç©ºçš„
                    if (firstLine) {
                        try {
                            // è§£æ JSON å­—ç¬¦ä¸²
                            const json = JSON.parse(firstLine);
                            // å°†è§£æçš„ JSON append to the existing bindings
                            bindings.push(...json);
                            renderBindings();  // æ¸²æŸ“ç»‘å®šæ•°æ®
                        } catch (e) {
                            showPopup("ä¸æ˜åŸå› å¯¼è‡´json-bindingsè§£æå¤±è´¥" + e, 'popupContainer');
                            console.error("JSON è§£æå¤±è´¥:" + e, e);
                        }
                    }
                }
            }

            // Find a line call "//json-templates"
            jsonIndex = content.indexOf('//json-templates');
            if (jsonIndex >= 0) {
                const jsonStr = content.substring(jsonIndex + 18).trim(); // skin "//json-templates\n"
                // è·³è¿‡ "//"
                if (jsonStr.startsWith('//')) {
                    const firstLine = jsonStr.substring(2).split('\n')[0]; // Skip "//" at the start
                    // å¦‚æœå†…å®¹ä¸æ˜¯ç©ºçš„
                    if (firstLine) {
                        try {
                            // è§£æ JSON å­—ç¬¦ä¸²
                            const json = JSON.parse(firstLine);
                            // å°†è§£æçš„ JSON append to the existing templates
                            templates.push(...json);
                            RenderTemplates();  // æ¸²æŸ“ç»‘å®šæ•°æ®
                        } catch (e) {
                            showPopup("ä¸æ˜åŸå› å¯¼è‡´json-templatesè§£æå¤±è´¥" + e, 'popupContainer');
                            console.error("JSON è§£æå¤±è´¥:" + e, e);
                        }
                    }
                }
            }
        }

        // æ–‡ä»¶å¯¼å‡º
        function exportSettings() {
            try {
                // Construct the content string as three parts:
                // 1. the first line "//poyakong.cfg"
                // 2. for each binding, extractAsEcho() + extractAsCmd() + '\n'
                // 3. the JSON string for the bindings array
                const content = `//poyakong.cfg\n` +
                    `//` + appTitle.textContent + '\n' +
                    `//ä½œè€…: ç ´äºšç©º-Yakong-P\n` +
                    `//æ„ç­‘æ—¶é—´: ` + new Date().toLocaleString() + '\n' +
                    '\n' +
                    '\n' +
                    bindings.map(binding => {
                        // æ£€æŸ¥ binding.bind æ˜¯å¦ä¸ºç©ºï¼Œç©ºåˆ™è·³è¿‡
                        if (!binding.bind) {
                            return '';
                        }
                        return extractAsEcho(binding) + extractAsCmd(binding) + '\n';
                    }).join('') +
                    '\n' +
                    '\n' +
                    `//json-bindings\n` +
                    `//` + extractAsJson(bindings);
                '\n' +
                    '\n' +
                    `//json-templates\n` +
                    `//` + extractAsJson(templates);

                // Create a file and write the content to it with name poyakong.cfg
                const file = new File([content], 'poyakong.cfg', { type: 'text/plain' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(file);
                link.download = 'poyakong.cfg';

                // Trigger download
                link.click();

                // Show success popup
                showPopup("ä¿å­˜æˆåŠŸï¼Œè¯·å°†.cfgæ–‡ä»¶æ”¾ç½®åˆ°CounterStrike: Global Offesive/game/csgo/cfgæ–‡ä»¶å¤¹ä¸­ï¼Œå¹¶åœ¨æ¸¸æˆå†…æ§åˆ¶å°è¾“å…¥exec poyakong", 'popupContainer');
            } catch (error) {
                // Log the error (for debugging purposes)
                console.error("å¯¼å‡ºæ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯:", error);

                // Show error popup
                showPopup("ä¿å­˜å¤±è´¥ï¼Œäº§ç”Ÿäº†é¢„æ–™ä¹‹å¤–çš„é”™è¯¯ " + errer, 'popupContainer');
            }
        }

        // Cmd
        function extractAsCmd(binding) {
            // check if the bind is empty
            if (!binding.bind) {
                return "";
            }
            // extract the bind and command
            const bind = binding.bind;
            const command = binding.command;
            // replace the "[key]" in the command with the bind
            let cmd = command.replace(/\[key\]/g, bind);
            // check every \n if they missing ; as ;\n
            cmd = cmd
                .split('\n')
                .map(line => (line.endsWith(';') ? line : line + ';'))
                .join('\n');

            // return the cmd
            return cmd;
        }

        // echo
        function extractAsEcho(binding) {
            // check if the bind is empty
            if (!binding.bind) {
                return "";
            }
            // extract the description and keybind
            const description = binding.description;
            const bind = binding.bind;
            // return the echo
            return `echo \[${bind}\]ç»‘å®šä¸º${description}\n`;
        }

        // json
        function extractAsJson(bindings) {
            return JSON.stringify(bindings, null, 0);
        }


        // è‡ªåŠ¨è°ƒæ•´ textarea é«˜åº¦
        function autoResizeTextarea() {
            const textarea = document.querySelectorAll('textarea');
            textarea.forEach((el) => {
                el.addEventListener('input', () => {
                    el.style.height = 'auto';  // é‡ç½®é«˜åº¦
                    el.style.height = el.scrollHeight - 15 + 'px';  // è®¾ç½®é«˜åº¦ä¸ºå†…å®¹çš„å®é™…é«˜åº¦
                });
            });
        }

        // åˆå§‹åŒ–è‡ªåŠ¨è°ƒæ•´é«˜åº¦çš„åŠŸèƒ½
        autoResizeTextarea();

        function setupKeyDetector(binding, index) {
            // Create a full-screen overlay for key detection
            const keyDetectorOverlay = document.createElement('div');
            keyDetectorOverlay.classList.add('keyDetectorOverlay');

            keyDetectorOverlay.textContent = 'è¯·è¾“å…¥æŒ‰é”®\næˆ–æŒ‰ESCé€€å‡º';

            const specialKeyMappings = {
                // Numpad keys
                'NumpadAdd': 'kp_plus',
                'NumpadSubtract': 'kp_minus',
                'NumpadMultiply': 'kp_multiply',
                'NumpadDivide': 'kp_divide',
                'NumpadEnter': 'kp_enter',
                'NumpadDecimal': 'kp_del',

                // Modifier keys
                'ControlRight': 'rctrl',
                'ShiftRight': 'rshift',
                'AltRight': 'ralt',

                // Additional special keys
                'Tab': 'tab',
                'CapsLock': 'capslock',
                'Insert': 'ins',
                'Delete': 'del',
                'Home': 'home',
                'End': 'end',
                'PageUp': 'pgup',
                'PageDown': 'pgdn',
                'ScrollLock': 'scrolllock',
                'Pause': 'pause'

                // 'MetaRight': 'rwin'
            };

            // Numpad digit mapping
            for (let i = 0; i <= 9; i++) {
                specialKeyMappings[`Numpad${i}`] = `kp_${i}`;
            }

            // Add key event listener
            const keyHandler = (event) => {
                // Prevent default to stop propagation
                event.preventDefault();

                // Check for ESC key to exit
                if (event.key === 'Escape') {
                    document.body.removeChild(keyDetectorOverlay);
                    document.removeEventListener('keydown', keyHandler);
                    return;
                }

                // Check for modifier keys first
                if (['Control', 'Shift', 'Alt', 'CapsLock', 'Tab'].includes(event.key)) {
                    let modifierKey = '';
                    if (event.ctrlKey) modifierKey = event.location === event.DOM_KEY_LOCATION_RIGHT ? 'rctrl' : 'ctrl';
                    if (event.shiftKey) modifierKey = event.location === event.DOM_KEY_LOCATION_RIGHT ? 'rshift' : 'shift';
                    if (event.altKey) modifierKey = event.location === event.DOM_KEY_LOCATION_RIGHT ? 'ralt' : 'alt';

                    // Check for other special keys
                    const specialKeyMap = {
                        'CapsLock': 'capslock',
                        'Tab': 'tab'
                    };

                    modifierKey = modifierKey || specialKeyMap[event.key];

                    if (modifierKey) {
                        bindings[index].bind = modifierKey;

                        // Remove the overlay
                        document.body.removeChild(keyDetectorOverlay);
                        document.removeEventListener('keydown', keyHandler);

                        // Re-render the bindings to reflect the change
                        renderBindings();
                        return;
                    }
                }

                // Check for mappable special keys
                const specialKey = specialKeyMappings[event.code] || specialKeyMappings[event.key];

                // Determine the key to use
                const bindKey = specialKey ||
                    (event.key.length === 1 ? event.key :
                        (['F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'F11', 'F12'].includes(event.key) ? event.key : null));

                if (bindKey) {
                    // Update the binding with the new key
                    bindings[index].bind = bindKey;

                    // Remove the overlay
                    document.body.removeChild(keyDetectorOverlay);
                    document.removeEventListener('keydown', keyHandler);

                    // Re-render the bindings to reflect the change
                    renderBindings();
                }
            };

            // Add event listener and append to body
            document.addEventListener('keydown', keyHandler);
            document.body.appendChild(keyDetectorOverlay);
        }

        // builders exporter
        function exportBuilders() {
            const content = 
                `//poyakong.cfg\n` +
                `//template builder\n` +
                bindings.map(binding => {
                    return `//${binding.description}\n` +
                        `//${binding.bind}\n` +
                        `//${binding.command}\n` +
                        `//${binding.tags}\n`;
                }).join('');

            // Create a file and write the content to it with name poyakong.cfg
            const file = new File([content], 'poyakong.cfg', { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(file);
            link.download = 'poyakong.cfg';

            // Trigger download
            link.click();

            // Show success popup
            showPopup("Builderå¯¼å‡ºæˆåŠŸ", 'popupContainer');
        }
    </script>
</body>

</html>